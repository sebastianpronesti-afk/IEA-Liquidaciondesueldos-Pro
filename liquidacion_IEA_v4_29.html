<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>IEA Liquidaci√≥n Pro v4.29</title>
<link href="https://cdn.jsdelivr.net" rel="preconnect"/>
<style>
    :root{
      --bg:#e9eff2; --card:#ffffff; --green:#0c4b3f; --green2:#0a3f35;
      --gold:#d8a316; --muted:#6b7280; --shadow: 0 10px 25px rgba(0,0,0,.10); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 800px at 50% -200px, rgba(12,75,63,.25), transparent 60%), var(--bg);
      color:#0b1220;
    }
    header{
      background: linear-gradient(180deg, var(--green), var(--green2));
      color:#fff; padding:22px 28px; position:sticky; top:0; z-index:50; box-shadow: 0 8px 25px rgba(0,0,0,.20);
    }
    .headerRow{ display:flex; align-items:center; justify-content:space-between; max-width:1200px; margin:0 auto; }
    .brand{ font-weight:900; font-size:34px; display:flex; align-items:baseline; gap:10px; }
    .brand span:nth-child(2){ color:var(--gold); font-size:28px; }
    .societyToggle{ background: rgba(255,255,255,.12); padding:6px; border-radius:14px; display:flex; gap:6px; }
    .societyToggle button{
      border:0; padding:10px 16px; border-radius:12px; cursor:pointer; color:#fff;
      background:transparent; font-weight:800;
    }
    .societyToggle button.active{ background: var(--gold); color:#14231f; }
    .container{ max-width:1200px; margin:22px auto 40px; padding:0 18px; }
    .nav{
      background:rgba(255,255,255,.75); backdrop-filter: blur(8px); border-radius: var(--radius);
      box-shadow: var(--shadow); padding:10px; display:flex; gap:10px; justify-content:space-between; overflow:auto;
    }
    .tabs{ display:flex; gap:10px; }
    .tab{
      border:0; background:transparent; cursor:pointer; padding:14px 16px; border-radius:14px;
      font-weight:900; color:#1f2937; display:flex; align-items:center; gap:8px;
    }
    .tab.active{ background: var(--green); color:#fff; }
    .section{ margin-top:18px; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding:22px; }
    .section.hidden{ display:none; }
    h2{ margin:0 0 12px; color:#0f3d33; font-family: monospace; font-size:30px; }
    .divider{ height:2px; background:rgba(15,61,51,.14); margin:10px 0 18px; border-radius:999px; }
    .cards{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px; }
    .metric{
      border-radius:18px; background: linear-gradient(180deg, #0c4b3f, #0a3f35);
      color:#fff; padding:18px; min-height:110px; display:flex; flex-direction:column; justify-content:space-between;
    }
    .metric .label{ font-weight:900; opacity:.8; font-family: monospace; font-size:12px; }
    .metric .value{ font-size:40px; font-weight:900; }
    .controls{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-bottom:15px; }
    label{ display:flex; flex-direction:column; gap:6px; font-weight:800; font-size:12px; color:var(--muted); }
    select, input{
      border:2px solid rgba(17,24,39,.15); border-radius:12px; padding:10px; font-size:15px; outline:none;
    }
    input:focus{ border-color: var(--green); }
    .btn{ border:0; border-radius:12px; padding:10px 18px; font-weight:900; cursor:pointer; color:#fff; background:#6b7280; }
    .btn.primary{ background:var(--green); }
    .btn.danger{ background:#b91c1c; }
    .tableWrap{ margin-top:14px; border-radius:18px; overflow:auto; border:1px solid rgba(12,75,63,.1); }
    table{ width:100%; border-collapse:collapse; min-width:1000px; }
    thead th{ background:#0c4b3f; color:#fff; padding:15px; text-align:left; font-size:13px; font-family: monospace; }
    tbody td{ padding:15px; border-top:1px solid #eee; font-size:14px; }
    .toast{
      position:fixed; right:20px; bottom:20px; background:#111; color:#fff; padding:15px 25px;
      border-radius:12px; display:none; z-index:1000; font-weight:700;
    }
    .toast.show{ display:block; }
    .hint{ background: rgba(216,163,22,0.1); border: 1px solid var(--gold); padding: 10px; border-radius: 10px; font-size: 13px; }
  
    /* Modal editor empleados */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center;
      z-index:1200; padding:18px;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width:min(980px, 100%); max-height:90vh; overflow:auto;
      background:var(--card); border-radius:22px; box-shadow: 0 18px 50px rgba(0,0,0,.35); padding:18px;
    }
    .modalHead{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .modalHead h3{ margin:0; font-size:18px; color:#0f3d33; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    @media (max-width: 820px){
      .grid2, .grid3{ grid-template-columns:1fr; }
    }
    .smallHelp{ font-size:12px; color:var(--muted); }

  </style>
</head>
<body>
<header>
<div class="headerRow">
<div class="brand"><span>Liquidaci√≥n</span><span>Pro</span></div>
<div class="societyToggle">
<button class="active" data-soc="CFPEA">CFPEA SRL</button>
<button data-soc="ISFTEA">ISFTEA SRL</button>
</div>
</div>
</header>
<main class="container">
<div class="nav">
<div class="tabs">
<button class="tab active" data-tab="dashboard">üìä Dashboard</button>
<button class="tab" data-tab="empleados">üë• Empleados</button>
<button class="tab" data-tab="antiguedades">üìÖ Antig√ºedades</button>
<button class="tab" data-tab="novedades">üìù Novedades</button>
<button class="tab" data-tab="auditoria">üìã Auditor√≠a</button>
</div>
<button class="btn" id="btnReset">Reset Local</button>
</div>
<!-- DASHBOARD -->
<section class="section" id="sec-dashboard">
<h2>Resumen General</h2>
<div class="divider"></div>
<div class="cards">
<div class="metric"><div class="label">EMPLEADOS EN SOCIEDAD</div><div class="value" id="mTotalEmp">0</div></div>
<div class="metric"><div class="label">CARGOS ACTIVOS</div><div class="value" id="mCargosAct">0</div></div>

<div class="metric"><div class="label">CARGOS FORMACI√ìN</div><div class="value" id="mCargosForm">0</div></div>
<div class="metric"><div class="label">CARGOS SUPERIOR</div><div class="value" id="mCargosSup">0</div></div>
<div class="metric"><div class="label">CARGOS MEDIA</div><div class="value" id="mCargosMed">0</div></div>
<div class="metric" style="background:var(--gold); color:#111"><div class="label">SOCIEDAD ACTUAL</div><div class="value" id="mSocLabel">CFPEA</div></div>
</div>
<div class="controls" style="margin-top:14px; flex-wrap:wrap">
<label>Nivel de liquidaci√≥n (afecta escalas si aplica)
      <select id="nivelLiquidacion">
<option value="FORMACION">FORMACION</option>
<option value="MEDIA">MEDIA</option>
<option value="SUPERIOR">SUPERIOR</option>
</select>
</label>
<button class="btn" id="btnDbExport">Descargar respaldo (JSON)</button>
<label style="min-width:260px">Cargar respaldo (JSON)
      <input accept=".json" id="dbImportFile" type="file"/>
</label>
<button class="btn" id="btnDbImport">Importar respaldo</button>
<div class="hint" style="margin-left:auto; max-width:520px">
      Nota: los datos se guardan localmente en esta PC/navegador. Para compartir entre personas us√° el respaldo JSON.
    </div>
</div>
</section>
<!-- EMPLEADOS -->
<section class="section hidden" id="sec-empleados">
<h2>Lista de Empleados</h2>
<div class="controls">
<input id="searchEmp" placeholder="Buscar por Nombre o CUIL..." style="flex:1" type="text"/>
<button class="btn" id="btnExport">Exportar CSV</button>
<button class="btn" id="btnShowImport">Importar Empleados</button>
</div>
<div class="tableWrap">
<table>
<thead>
<tr>
<th>SECCI√ìN</th><th>CUIL</th><th>APELLIDO Y NOMBRE</th><th>CARGO</th><th>HORAS</th><th>ESTADO</th><th>ACCIONES</th>
</tr>
</thead>
<tbody id="tbodyEmp"></tbody>
</table>
</div>
<div class="section" id="importadorEmpleados" style="background:#f9f9f9; margin-top:30px; display:none">
<h3>Importaci√≥n Masiva Inteligente (Upsert + Mapeo de Columnas)</h3>
<p class="muted small">
    Sub√≠ un Excel/CSV. El sistema <b>detecta encabezados</b> y te deja mapear columnas a campos.
    Si falta alguna columna, ese dato queda en blanco. Si el CUIL existe, se <b>actualiza</b>; si no existe, se <b>crea</b>.
    Los cargos se agregan a la <b>sociedad activa</b>.
  </p>
<div class="controls">
<label>Archivo Excel/CSV
      <input accept=".xlsx,.xls,.csv" id="impFile" type="file"/>
</label>
<button class="btn" id="btnImpDetect">Detectar columnas</button>
<button class="btn primary" disabled="" id="btnImport">Procesar Importaci√≥n</button>
</div>
<div class="section" id="impMapWrap" style="background:#fff; border:1px solid rgba(12,75,63,.12); margin-top:14px; padding:16px; display:none">
<div class="hint" style="margin-bottom:12px">
      Mape√° cada campo al encabezado correcto. <b>CUIL</b> es obligatorio. Los dem√°s son opcionales.
      Consejo: si tu planilla trae <b>P1/P2</b>, usalos en Cargo/Horas para importar cargos bien.
    </div>
<div class="controls" id="impMapGrid" style="align-items:flex-end"></div>
<div class="controls" style="margin-top:8px">
<label style="flex-direction:row; align-items:center; gap:10px; font-size:13px">
<input checked="" id="impSkipEmptyCargo" type="checkbox"/>
        Si falta Secci√≥n o Cargo, <b>no</b> crear cargo (solo actualizar empleado)
      </label>
<span class="hint" id="impPreview" style="margin-left:auto">Esperando archivo‚Ä¶</span>
</div>
<div class="hint" id="impSample" style="margin-top:10px; overflow:auto; max-height:260px;"></div>
</div>
</div>
</section>
<!-- ANTIG√úEDADES -->
<section class="section hidden" id="sec-antiguedades">
  <h2>Control de Antig√ºedades</h2>
  <div class="hint" style="border:1px solid rgba(12,75,63,.6); background:rgba(12,75,63,.06); color:#1b1b1b; margin-bottom:14px">
    <b>Panel de control de antig√ºedades:</b> Valid√° que las fechas de alta est√©n correctas, detect√° inconsistencias autom√°ticamente, y export√° para comparar con el liquidador.
  </div>

  <!-- M√©tricas de antig√ºedad -->
  <div class="cards" style="margin-bottom:18px">
    <div class="metric"><div class="label">EMPLEADOS EN SOCIEDAD</div><div class="value" id="antTotalEmp">0</div></div>
    <div class="metric" style="background:#059669"><div class="label">‚úì SIN ALERTAS</div><div class="value" id="antSinAlertas">0</div></div>
    <div class="metric" style="background:#d97706"><div class="label">‚ö† CON ALERTAS</div><div class="value" id="antConAlertas">0</div></div>
    <div class="metric" style="background:#dc2626"><div class="label">‚úó SIN FECHA ALTA</div><div class="value" id="antSinFecha">0</div></div>
  </div>

  <!-- Controles -->
  <div class="controls" style="flex-wrap:wrap; margin-bottom:14px">
    <input id="searchAnt" placeholder="Buscar por Nombre o CUIL..." style="flex:1; min-width:200px" type="text"/>
    <label style="flex-direction:row; align-items:center; gap:8px; font-size:13px">
      <input type="checkbox" id="antSoloAlertas"/>
      Mostrar solo con alertas
    </label>
    <button class="btn" id="btnExportAntiguedades">Exportar Antig√ºedades (XLSX)</button>
    <button class="btn primary" id="btnCompararAntiguedades">Comparar con Liquidador</button>
  </div>

  <!-- Tabla de antig√ºedades -->
  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th style="width:50px">ESTADO</th>
          <th>CUIL</th>
          <th>APELLIDO Y NOMBRE</th>
          <th>FECHA ALTA ESTAB.</th>
          <th>ANTIG√úEDAD</th>
          <th style="min-width:200px">ALERTAS</th>
          <th>ACCIONES</th>
        </tr>
      </thead>
      <tbody id="tbodyAnt"></tbody>
    </table>
  </div>

  <!-- Panel de comparaci√≥n con liquidador -->
  <div class="section" id="antComparadorPanel" style="background:#fff; border:1px solid rgba(218,169,51,.45); padding:14px 16px; margin-top:18px; display:none">
    <h3 style="margin:0 0 10px 0; color:#0f3d33">üîç Comparar Antig√ºedades con Liquidador</h3>
    <div class="hint" style="margin-bottom:12px">
      Sub√≠ la planilla del liquidador que contiene las antig√ºedades. El sistema comparar√° autom√°ticamente los valores y mostrar√° las diferencias.
    </div>
    <div class="controls" style="flex-wrap:wrap">
      <label>Archivo del liquidador (XLSX/CSV)
        <input type="file" id="antCompFile" accept=".xlsx,.xls,.csv"/>
      </label>
      <button class="btn" id="btnAntCompDetect">Detectar columnas</button>
      <button class="btn primary" id="btnAntCompAnalyze" disabled>Analizar diferencias</button>
      <button class="btn" id="btnAntCompClose">Cerrar comparador</button>
    </div>
    <div class="hint" id="antCompPreview" style="margin-top:10px">Esperando archivo‚Ä¶</div>
    <div class="grid3" id="antCompMapGrid" style="margin-top:10px"></div>
    <div id="antCompResultWrap" style="margin-top:14px"></div>
  </div>

  <!-- Leyenda -->
  <div class="hint" style="margin-top:14px; display:flex; gap:20px; flex-wrap:wrap">
    <span><span style="display:inline-block; width:18px; height:18px; background:#059669; border-radius:50%; vertical-align:middle; margin-right:6px"></span> Sin alertas</span>
    <span><span style="display:inline-block; width:18px; height:18px; background:#d97706; border-radius:50%; vertical-align:middle; margin-right:6px"></span> Con alertas menores</span>
    <span><span style="display:inline-block; width:18px; height:18px; background:#dc2626; border-radius:50%; vertical-align:middle; margin-right:6px"></span> Sin fecha de alta / Error cr√≠tico</span>
  </div>
</section>
<!-- NOVEDADES -->
<section class="section hidden" id="sec-novedades">
  <h2>Novedades</h2>
  <div class="hint" style="border:1px solid rgba(218,169,51,.6); background:rgba(218,169,51,.09); color:#1b1b1b">
    Trabaj√° por per√≠odo (AAAA-MM): <b>export√°s</b> planillas para que el personal cargue novedades y se las env√≠e al liquidador, y luego <b>import√°s</b> archivos para cargar novedades masivas o <b>controlar</b> que la liquidaci√≥n devuelta no altere datos maestros (antig√ºedad, altas, horas).
  </div>

  <div class="grid2" style="margin-top:14px; gap:14px">
    <!-- EXPORTABLES -->
    <div class="section" style="background:#fff; border:1px solid rgba(12,75,63,.12); padding:14px 16px">
      <h3 style="margin:0 0 10px 0">Exportables</h3>

      <div class="controls" style="flex-wrap:wrap">
        <label>Per√≠odo activo
          <input type="month" id="novPeriodo" value=""/>
        </label>
        <div class="pill" style="background:rgba(12,75,63,.08); color:var(--green); padding:10px 12px; border-radius:14px; font-weight:900; margin-top:18px">
          Estado: <span id="periodoEstadoTxt">abierto</span>
        </div>
      </div>

      <div class="controls" style="margin-top:10px; flex-wrap:wrap">
        <button class="btn" id="btnPeriodoEnviar">Enviar a liquidador</button>
        <button class="btn" id="btnPeriodoLiquidado">Marcar liquidado</button>
        <button class="btn" id="btnPeriodoRevisado">Marcar revisado</button>
        <button class="btn" id="btnPeriodoAprobado">Aprobar</button>
        <button class="btn danger" id="btnPeriodoCerrar">Cerrar</button>
        <button class="btn" id="btnPeriodoAbrir">Reabrir</button>
      </div>

      <div class="controls" style="margin-top:10px; flex-wrap:wrap">
        <button class="btn" id="btnExportNovLiquidador">Export para liquidador (CSV)</button>
        <button class="btn" id="btnExportNovRevision">Export para revisi√≥n (CSV)</button>
        <button class="btn" id="btnDiffEnviado">Comparar con enviado</button>
        <button class="btn primary" id="btnExportPlanillaLiquidadorXlsx">Exportar planilla de novedades (XLSX)</button>
      </div>

      <div class="divider" style="margin:14px 0"></div>

      <div class="section" style="background:rgba(12,75,63,.04); border:1px solid rgba(12,75,63,.12); padding:12px 14px">
        <h4 style="margin:0 0 10px 0; color:#0f3d33">Cargar novedad manual</h4>
        <div class="controls" style="flex-wrap:wrap">
          <label>Empleado
            <select id="novEmpSelect"><option value="">Seleccionar...</option></select>
          </label>
          <label>Cargo
            <select id="novCargoSelect"><option value="">Seleccionar...</option></select>
          </label>
          <label>Tipo
            <select id="novTipoManual">
              <option value="Descuento Horas (DTO. OBL)">Descuento Horas (DTO. OBL)</option>
              <option value="Licencia">Licencia</option>
              <option value="Horas Extras">Horas Extras</option>
              <option value="Bonificaci√≥n">Bonificaci√≥n</option>
              <option value="Baja Cargo">Baja Cargo</option>
              <option value="Otro">Otro</option>
            </select>
          </label>
          <label>Valor (hs / d√≠as / $)<input id="novVal" type="number" step="0.5"/></label>
          <label>Fecha (opcional)<input id="novFecha" type="date"/></label>
          <label style="flex:1; min-width:260px">Detalle / Observaci√≥n
            <input id="novDetalle" type="text" placeholder="Ej: Licencia m√©dica / Observaciones..."/>
          </label>
          <button class="btn primary" id="btnAddNov">Agregar</button>
        </div>
        <div class="hint" id="novAlertsHint" style="margin-top:10px"></div>
      </div>

      <div class="section" style="background:rgba(12,75,63,.04); border:1px solid rgba(12,75,63,.12); padding:12px 14px; margin-top:12px">
        <h4 style="margin:0 0 10px 0; color:#0f3d33">Bit√°cora del per√≠odo</h4>
        <div class="controls" style="flex-wrap:wrap">
          <input id="periodoNota" placeholder="Nota / comentario (opcional)" style="flex:1; min-width:260px"/>
          <button class="btn" id="btnAddPeriodoNota">Agregar nota</button>
        </div>
        <div class="hint" id="periodoBitacora" style="margin-top:10px; white-space:pre-wrap">Sin notas.</div>
      </div>
    </div>

    <!-- IMPORTABLES -->
    <div class="section" style="background:#fff; border:1px solid rgba(12,75,63,.12); padding:14px 16px">
      <h3 style="margin:0 0 10px 0">Importables</h3>

      <!-- Importar novedades -->
      <div class="section" style="background:rgba(12,75,63,.04); border:1px solid rgba(12,75,63,.12); padding:12px 14px">
        <h4 style="margin:0 0 8px 0; color:#0f3d33">1) Importar novedades (Excel/CSV del personal)</h4>
        <div class="hint" style="margin:0 0 10px 0">
          Carg√° un archivo de novedades. El sistema detecta encabezados, te deja mapear columnas y crea novedades en el per√≠odo (AAAA-MM).
          Si el per√≠odo est√° <b>cerrado</b>, no permite importar.
        </div>

        <div class="controls" style="flex-wrap:wrap">
          <label>Archivo Excel/CSV
            <input type="file" id="novImpFile" accept=".xlsx,.xls,.csv"/>
          </label>
          <button class="btn" id="btnNovImpDetect">Detectar columnas</button>
          <button class="btn primary" id="btnNovImpImport" disabled>Importar novedades</button>
        </div>

        <div class="controls" style="margin-top:10px; flex-wrap:wrap">
          <label style="display:flex; align-items:center; gap:10px">
            <input type="checkbox" id="chkNovPeriodoFallback" checked/>
            Si falta AA/MM, usar per√≠odo activo
          </label>
          <label style="display:flex; align-items:center; gap:10px">
            <input type="checkbox" id="chkNovUpdateMaster" />
            Actualizar datos maestro (opcional)
          </label>
          <label style="display:flex; align-items:center; gap:10px">
            <input type="checkbox" id="chkNovCreateMissingEmp" />
            Crear empleado faltante (si no existe)
          </label>
          <label style="display:flex; align-items:center; gap:10px">
            <input type="checkbox" id="chkNovCreateMissingCargo" />
            Crear cargo faltante (si no existe)
          </label>
          <button class="btn" id="btnNovDownloadRejected" style="display:none">Descargar rechazadas</button>
        </div>

        <div class="hint" id="novImpPreview" style="margin-top:10px">Esperando archivo‚Ä¶</div>
        <div class="grid3" id="novImpMapGrid" style="margin-top:10px"></div>
        <div id="novImpSampleWrap" style="margin-top:10px"></div>
        <div class="hint" id="novImpReport" style="margin-top:10px"></div>
      </div>

      <!-- Control liquidaci√≥n -->
      <div class="section" style="background:rgba(218,169,51,.08); border:1px solid rgba(218,169,51,.45); padding:12px 14px; margin-top:12px">
        <h4 style="margin:0 0 8px 0; color:#0f3d33">2) Importar liquidaci√≥n del liquidador (control)</h4>
        <div class="hint" style="margin:0 0 10px 0">
          Import√° la planilla final que te devuelve el liquidador y el sistema genera un <b>reporte de diferencias</b> contra tu base (ej. antig√ºedad, altas, horas).
          <b>No modifica</b> datos: solo controla.
        </div>

        <div class="controls" style="flex-wrap:wrap">
          <label>Archivo liquidaci√≥n (XLSX/CSV)
            <input type="file" id="liqCtrlFile" accept=".xlsx,.xls,.csv"/>
          </label>
          <button class="btn" id="btnLiqCtrlDetect">Detectar columnas</button>
          <button class="btn primary" id="btnLiqCtrlAnalyze" disabled>Analizar diferencias</button>
          <button class="btn" id="btnLiqCtrlDownloadDiff" disabled>Descargar diferencias (CSV)</button>
        </div>

        <div class="hint" id="liqCtrlPreview" style="margin-top:10px">Esperando archivo‚Ä¶</div>
        <div class="grid3" id="liqCtrlMapGrid" style="margin-top:10px"></div>
        <div class="hint" id="liqCtrlReport" style="margin-top:10px"></div>
        <div id="liqCtrlDiffWrap" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div class="tableWrap" style="margin-top:14px">
    <table>
      <thead>
        <tr>
          <th>PER√çODO</th><th>EMPLEADO</th><th>CARGO</th><th>TIPO</th><th>VALOR</th><th>DETALLE</th><th>ESTADO</th><th>ORIGEN</th><th>ACCIONES</th>
        </tr>
      </thead>
      <tbody id="tbodyNov"></tbody>
    </table>
  </div>
</section>
<!-- AUDITOR√çA -->
<section class="section hidden" id="sec-auditoria">
  <h2>Log de Auditor√≠a</h2>
  <div class="hint" style="border:1px solid rgba(12,75,63,.6); background:rgba(12,75,63,.06); color:#1b1b1b; margin-bottom:14px">
    <b>Registro autom√°tico de cambios:</b> Cada modificaci√≥n en empleados, cargos o novedades queda registrada con fecha, hora, campo modificado, valor anterior y nuevo.
  </div>

  <!-- M√©tricas de auditor√≠a -->
  <div class="cards" style="margin-bottom:18px">
    <div class="metric"><div class="label">CAMBIOS HOY</div><div class="value" id="audHoy">0</div></div>
    <div class="metric"><div class="label">CAMBIOS ESTA SEMANA</div><div class="value" id="audSemana">0</div></div>
    <div class="metric"><div class="label">CAMBIOS ESTE MES</div><div class="value" id="audMes">0</div></div>
    <div class="metric" style="background:var(--gold); color:#111"><div class="label">TOTAL REGISTROS</div><div class="value" id="audTotal">0</div></div>
  </div>

  <!-- Controles -->
  <div class="controls" style="flex-wrap:wrap; margin-bottom:14px">
    <input id="searchAud" placeholder="Buscar por empleado, campo o valor..." style="flex:1; min-width:200px" type="text"/>
    <label>Desde
      <input type="date" id="audFechaDesde"/>
    </label>
    <label>Hasta
      <input type="date" id="audFechaHasta"/>
    </label>
    <label>Tipo de cambio
      <select id="audTipoCambio">
        <option value="">Todos</option>
        <option value="empleado">Empleado</option>
        <option value="cargo">Cargo</option>
        <option value="novedad">Novedad</option>
        <option value="periodo">Per√≠odo</option>
        <option value="importacion">Importaci√≥n</option>
      </select>
    </label>
    <button class="btn" id="btnAudFiltrar">Filtrar</button>
    <button class="btn" id="btnAudLimpiarFiltros">Limpiar filtros</button>
    <button class="btn" id="btnExportAuditoria">Exportar Log (CSV)</button>
  </div>

  <!-- Tabla de auditor√≠a -->
  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th style="width:160px">FECHA/HORA</th>
          <th>TIPO</th>
          <th>EMPLEADO</th>
          <th>CAMPO</th>
          <th>VALOR ANTERIOR</th>
          <th>VALOR NUEVO</th>
          <th style="width:180px">DETALLE</th>
        </tr>
      </thead>
      <tbody id="tbodyAud"></tbody>
    </table>
  </div>

  <!-- Paginaci√≥n -->
  <div class="controls" style="margin-top:14px; justify-content:center">
    <button class="btn" id="btnAudPrev">‚Üê Anterior</button>
    <span id="audPagInfo" style="padding:10px 20px; font-weight:bold">P√°gina 1</span>
    <button class="btn" id="btnAudNext">Siguiente ‚Üí</button>
  </div>

  <div class="divider" style="margin:20px 0"></div>

  <!-- Comparador Mes a Mes -->
  <div class="section" style="background:#fff; border:1px solid rgba(12,75,63,.12); padding:16px">
    <h3 style="margin:0 0 12px 0; color:#0f3d33">üìä Comparador Mes a Mes</h3>
    <div class="hint" style="margin-bottom:12px">
      Compar√° el estado de la plantilla entre dos per√≠odos para ver: empleados agregados, dados de baja, cambios en horas, cambios en cargos.
    </div>
    <div class="controls" style="flex-wrap:wrap">
      <label>Per√≠odo base
        <input type="month" id="compPeriodoBase"/>
      </label>
      <label>Per√≠odo a comparar
        <input type="month" id="compPeriodoComp"/>
      </label>
      <button class="btn primary" id="btnCompararPeriodos">Comparar</button>
      <button class="btn" id="btnExportComparacion" disabled>Exportar comparaci√≥n (CSV)</button>
    </div>
    <div id="compResultWrap" style="margin-top:14px"></div>
  </div>

  <!-- Snapshots -->
  <div class="section" style="background:rgba(218,169,51,.08); border:1px solid rgba(218,169,51,.45); padding:16px; margin-top:14px">
    <h3 style="margin:0 0 12px 0; color:#0f3d33">üì∏ Snapshots de Estado</h3>
    <div class="hint" style="margin-bottom:12px">
      Guard√° una "foto" del estado actual de la plantilla para poder comparar despu√©s. √ötil antes de enviar al liquidador.
    </div>
    <div class="controls" style="flex-wrap:wrap">
      <label>Nombre del snapshot
        <input type="text" id="snapshotNombre" placeholder="Ej: Pre-env√≠o Enero 2025"/>
      </label>
      <button class="btn primary" id="btnCrearSnapshot">Crear Snapshot</button>
    </div>
    <div id="snapshotsListWrap" style="margin-top:14px"></div>
  </div>
</section>
</main>
<!-- MODAL: Editor de Empleado/Cargo -->
<div aria-hidden="true" class="modalBack" id="empModalBack">
<div aria-labelledby="empModalTitle" aria-modal="true" class="modal" role="dialog">
<div class="modalHead">
<h3 id="empModalTitle">Editar empleado</h3>
<button class="btn" id="btnEmpModalClose">Cerrar</button>
</div>
<div class="divider"></div>
<div class="hint" style="margin-bottom:12px">
      Edit√°s datos del <b>empleado</b> (global por CUIL) y del <b>cargo</b> seleccionado (en la sociedad activa).
      Si un empleado tiene m√∫ltiples cargos, se edita el cargo correspondiente a la fila donde tocaste <b>Editar</b>.
    </div>
<form id="empEditForm">
<input id="editEmpId" type="hidden"/>
<input id="editCargoId" type="hidden"/>
<h4 style="margin:10px 0 8px; color:#0f3d33">Datos del empleado</h4>
<div class="grid3">
<label>CUIL (11 d√≠gitos)
          <input id="editCuil" placeholder="20XXXXXXXXX"/>
</label>
<label>Apellido y Nombre
          <input id="editApellidoNombre" placeholder="APELLIDO, NOMBRE"/>
</label>
<label>Nivel
          <select id="editNivel">
<option value="FORMACION">FORMACION</option>
<option value="MEDIA">MEDIA</option>
<option value="SUPERIOR">SUPERIOR</option>
</select>
</label>
</div>
<div class="grid3" style="margin-top:10px">
<label>Per
          <input id="editPer" placeholder="Per"/>
</label>
<label>Subl
          <input id="editSubl" placeholder="Subl"/>
</label>
<label>Sit. Revista
          <input id="editSitRevista" placeholder="Sit. Revista"/>
</label>
</div>
<div class="grid3" style="margin-top:10px">
<label>% Jubilaci√≥n
          <input id="editPorcJub" placeholder="% jubilaci√≥n"/>
</label>
<label>Obra Social (C√≥digo + Nombre)
          <input id="editObraSocial" placeholder="Obra SOCIAL (CODIGO) + NOMBRE"/>
</label>
<label>Escalaf√≥n Antig√ºedad
          <input id="editEscAnt" placeholder="Escalada de Antiguedad"/>
</label>
</div>
<div class="grid2" style="margin-top:10px">
<label>Fecha de alta al establecimiento
          <input id="editFechaAltaEstab" placeholder="YYYY-MM-DD"/>
</label>
<div class="smallHelp" style="align-self:end">Tip: pod√©s pegar cualquier formato; se guarda como texto tal cual.</div>
</div>
<div class="section" style="background:rgba(12,75,63,.04); border:1px solid rgba(12,75,63,.12); padding:12px 14px; margin-top:12px">
<div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
<div style="font-weight:900; color:var(--green)">Antig√ºedad (sociedad activa)</div>
<div class="pill" style="background:rgba(12,75,63,.10); color:var(--green); padding:8px 10px; border-radius:12px; font-weight:900;">
            Total: <span id="empAntigTxt">0 d√≠as</span>
</div>
</div>
<div class="hint" style="margin-top:6px">
          El sistema conserva el historial de altas/bajas por sociedad. Al dar de baja, el per√≠odo se mueve al historial (no se borra).
        </div>
<div id="empHistList" style="margin-top:10px"></div>
<div class="controls" style="margin-top:10px; flex-wrap:wrap">
<label>Inicio (DD/MM/AAAA)
            <input id="histInicio" placeholder="01/01/2024"/>
</label>
<label>Fin (DD/MM/AAAA)
            <input id="histFin" placeholder="31/12/2024"/>
</label>
<button class="btn" id="btnHistAdd">Agregar al historial</button>
<label style="min-width:220px">Baja (fin del per√≠odo actual)
            <input id="histCloseFin" placeholder="hoy (vac√≠o) = hoy"/>
</label>
<button class="btn danger" id="btnHistClose">Cerrar per√≠odo actual</button>
</div>
</div>
<div class="divider"></div>
<h4 style="margin:10px 0 8px; color:#0f3d33">Datos del cargo (sociedad activa)</h4>
<div class="grid3">
<label>nro - nombre secci√≥n
          <input id="editSeccion" placeholder="nro - nombre seccion"/>
</label>
<label>Cargo
          <input id="editCargo" placeholder="Cargo"/>
</label>
<label>Categor√≠a
          <input id="editCategoria" placeholder="Categor√≠a"/>
</label>
</div>
<div class="grid3" style="margin-top:10px">
<label>P1
          <input id="editP1" placeholder="P1"/>
</label>
<label>P2
          <input id="editP2" placeholder="P2"/>
</label>
<label>Horas
          <input id="editHoras" placeholder="Horas"/>
</label>
</div>
<div class="grid3" style="margin-top:10px">
<label>AA
          <input id="editAA" placeholder="AA"/>
</label>
<label>MM
          <input id="editMM" placeholder="MM"/>
</label>
<label>PORC
          <input id="editPORC" placeholder="PORC"/>
</label>
</div>
<div class="grid3" style="margin-top:10px">
<label>Fecha de alta al cargo
          <input id="editFechaAltaCargo" placeholder="YYYY-MM-DD"/>
</label>
<label>Fecha de baja al cargo
          <input id="editFechaBajaCargo" placeholder="YYYY-MM-DD"/>
</label>
<label>Estado
          <select id="editEstado">
<option value="Activo">Activo</option>
<option value="Baja">Baja</option>
</select>
</label>
</div>
<div class="controls" style="margin-top:16px; justify-content:flex-end">
<button class="btn primary" id="btnEmpSave" type="button">Guardar cambios</button>
</div>
</form>
</div>
</div>
<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>

(() => {
  const $ = (id) => document.getElementById(id);
  const LS_KEY = "liq_v4_clean_db";

  // ---------- Utils ----------
  const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : (Date.now().toString(16) + Math.random().toString(16).slice(2)));
  const normCuil = (v) => String(v ?? "").replace(/\D/g, "").slice(0, 11);
  const formatCuil = (cuil11) => {
    const s = normCuil(cuil11);
    if (s.length !== 11) return s;
    return `${s.slice(0,2)}-${s.slice(2,10)}-${s.slice(10)}`;
  };
  const toUpper = (v) => String(v ?? "").trim().toUpperCase();
  const toNum = (v) => {
    const n = Number(String(v ?? "").replace(",", "."));
    return Number.isFinite(n) ? n : 0;
  };
  const escapeHtml = (str) => String(str ?? "").replace(/[&<>"']/g, (ch) => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[ch]));
  const toast = (m) => {
    const t = $("toast");
    t.textContent = m;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2500);
  };

  // ---------- DB ----------
  const defaultDB = () => ({ 
    empleados: [], 
    novedades: [], 
    periodosCerrados: [], 
    periodos: [], 
    auditoria: [],
    snapshots: [],
    config: { version: '4.29', nivelLiquidacionBySoc: { CFPEA: 'MEDIA', ISFTEA: 'SUPERIOR' } } 
  });
  let db;
  try { db = JSON.parse(localStorage.getItem(LS_KEY)) || defaultDB(); }
  catch { db = defaultDB(); }

  // Asegurar que existan las nuevas estructuras (migraci√≥n)
  if (!Array.isArray(db.auditoria)) db.auditoria = [];
  if (!Array.isArray(db.snapshots)) db.snapshots = [];

  // upgrade / shape guard


  // ---------- Config + Migraciones (v4.20) ----------
  db.config = (db.config && typeof db.config === "object") ? db.config : {};
  db.config.version = "4.21";
  db.config.nivelLiquidacionBySoc = db.config.nivelLiquidacionBySoc || { CFPEA: "MEDIA", ISFTEA: "SUPERIOR" };

  const normalizeNivel = (raw) => {
    const n = toUpper(String(raw ?? "")).trim();
    if (n.includes("FORM")) return "FORMACION";
    if (n.includes("SUP")) return "SUPERIOR";
    if (n.includes("MEDIA")) return "MEDIA";
    if (["FORMACION","MEDIA","SUPERIOR"].includes(n)) return n;
    return "";
  };

  const getNivelLiquidacion = (soc) => normalizeNivel(db.config.nivelLiquidacionBySoc?.[soc]) || "MEDIA";
  const setNivelLiquidacion = (soc, nivel) => {
    db.config.nivelLiquidacionBySoc = db.config.nivelLiquidacionBySoc || {};
    db.config.nivelLiquidacionBySoc[soc] = normalizeNivel(nivel) || "MEDIA";
  };

  // Historial de per√≠odos por establecimiento/sociedad (no se borra al dar de baja)
  const ensureEmpHist = (emp) => {
    emp.historialPeriodos = Array.isArray(emp.historialPeriodos) ? emp.historialPeriodos : [];
    emp.estabBySoc = (emp.estabBySoc && typeof emp.estabBySoc === "object") ? emp.estabBySoc : {};
    ["CFPEA","ISFTEA"].forEach(soc => {
      if (!emp.estabBySoc[soc] || typeof emp.estabBySoc[soc] !== "object") emp.estabBySoc[soc] = {};
      emp.estabBySoc[soc].fechaAltaEstab = String(emp.estabBySoc[soc].fechaAltaEstab ?? "").trim();
    });

    // Migraci√≥n suave desde campo legacy emp.fechaAltaEstab (si existe)
    if (emp.fechaAltaEstab && !emp.estabBySoc.CFPEA.fechaAltaEstab && !emp.estabBySoc.ISFTEA.fechaAltaEstab) {
      const hasCF = (emp.cargos || []).some(c => c.sociedad === "CFPEA");
      const hasIS = (emp.cargos || []).some(c => c.sociedad === "ISFTEA");
      if (hasCF) emp.estabBySoc.CFPEA.fechaAltaEstab = String(emp.fechaAltaEstab).trim();
      if (hasIS) emp.estabBySoc.ISFTEA.fechaAltaEstab = String(emp.fechaAltaEstab).trim();
      if (!hasCF && !hasIS) emp.estabBySoc[currentSoc].fechaAltaEstab = String(emp.fechaAltaEstab).trim();
    }
  };

  const parseDateFlexible = (s) => {
    const str = String(s ?? "").trim();
    if (!str) return null;

    // YYYY-MM-DD
    let m = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (m) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));

    // DD/MM/YYYY
    m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));

    // M/D/YYYY (t√≠pico de Excel exportado)
    m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) return new Date(Number(m[3]), Number(m[1]) - 1, Number(m[2]));

    // Date object from XLSX
    if (Object.prototype.toString.call(s) === "[object Date]" && !isNaN(s)) return s;

    return null;
  };

  const toDDMMYYYY = (s) => {
    const d = parseDateFlexible(s);
    if (!d) return String(s ?? "").trim();
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  };

  const daysBetweenInclusive = (a, b) => {
    const da = parseDateFlexible(a);
    const dbb = parseDateFlexible(b);
    if (!da || !dbb) return 0;
    const t1 = Date.UTC(da.getFullYear(), da.getMonth(), da.getDate());
    const t2 = Date.UTC(dbb.getFullYear(), dbb.getMonth(), dbb.getDate());
    const diff = Math.floor((t2 - t1) / 86400000);
    return diff >= 0 ? (diff + 1) : 0;
  };

  const todayDDMMYYYY = () => {
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  };

  const antiguedadDias = (emp, soc) => {
    ensureEmpHist(emp);
    const hist = emp.historialPeriodos.filter(p => (p?.sociedad || "") === soc);
    const sumHist = hist.reduce((acc, p) => acc + daysBetweenInclusive(p.inicio, p.fin), 0);
    const inicioActual = emp.estabBySoc?.[soc]?.fechaAltaEstab || "";
    const sumActual = inicioActual ? daysBetweenInclusive(inicioActual, todayDDMMYYYY()) : 0;
    return sumHist + sumActual;
  };

  // Ejecutar migraci√≥n shape a todos
  (db.empleados || []).forEach(ensureEmpHist);

  if (!Array.isArray(db.empleados)) db.empleados = [];
  if (!Array.isArray(db.novedades)) db.novedades = [];
  if (!Array.isArray(db.periodosCerrados)) db.periodosCerrados = [];
  if (!Array.isArray(db.periodos)) db.periodos = [];
  // upgrade novedades shape
  db.novedades.forEach(n => { if (!n.idNovedad) n.idNovedad = uid(); if (!n.sociedad) n.sociedad = "CFPEA"; if (!n.estado) n.estado = "cargada"; });
  // ensure idEmpleado exists
  db.empleados.forEach(e => { if (!e.idEmpleado) e.idEmpleado = uid(); });

  const save = () => localStorage.setItem(LS_KEY, JSON.stringify(db));

  // ---------- AUDITOR√çA: Sistema de logging autom√°tico ----------
  
  // Registrar un cambio en el log de auditor√≠a
  const logAudit = (tipo, datos) => {
    const entry = {
      id: uid(),
      timestamp: new Date().toISOString(),
      sociedad: currentSoc,
      tipo: tipo, // 'empleado', 'cargo', 'novedad', 'periodo', 'importacion', 'snapshot'
      idEmpleado: datos.idEmpleado || null,
      cuil: datos.cuil || null,
      nombreEmpleado: datos.nombreEmpleado || null,
      idCargo: datos.idCargo || null,
      campo: datos.campo || null,
      valorAnterior: datos.valorAnterior ?? null,
      valorNuevo: datos.valorNuevo ?? null,
      detalle: datos.detalle || null,
      accion: datos.accion || 'modificacion' // 'creacion', 'modificacion', 'eliminacion', 'importacion'
    };
    db.auditoria.unshift(entry); // Agregar al inicio para tener los m√°s recientes primero
    
    // Limitar a 5000 registros para no saturar localStorage
    if (db.auditoria.length > 5000) {
      db.auditoria = db.auditoria.slice(0, 5000);
    }
  };

  // Comparar dos objetos y registrar diferencias
  const auditarCambios = (tipo, idEmpleado, cuil, nombre, camposAntes, camposDespues, idCargo = null) => {
    const campos = Object.keys({ ...camposAntes, ...camposDespues });
    campos.forEach(campo => {
      const antes = String(camposAntes[campo] ?? '').trim();
      const despues = String(camposDespues[campo] ?? '').trim();
      if (antes !== despues) {
        logAudit(tipo, {
          idEmpleado,
          cuil,
          nombreEmpleado: nombre,
          idCargo,
          campo,
          valorAnterior: antes || '(vac√≠o)',
          valorNuevo: despues || '(vac√≠o)',
          accion: !antes && despues ? 'creacion' : !despues && antes ? 'eliminacion' : 'modificacion'
        });
      }
    });
  };

  // Estado de paginaci√≥n de auditor√≠a
  let audPagina = 1;
  const audPorPagina = 50;

  // ---------- State ----------
  let currentSoc = "CFPEA";
  if (db?.config?.currentSoc && ["CFPEA","ISFTEA"].includes(db.config.currentSoc)) currentSoc = db.config.currentSoc;

  // ---------- Domain (data logic) ----------
  const empleadosConCargoEnSoc = (soc) =>
    db.empleados.filter(e => Array.isArray(e.cargos) && e.cargos.some(c => c.sociedad === soc));

  const cargosEnSoc = (soc) => {
    const out = [];
    db.empleados.forEach(emp => {
      (emp.cargos || []).forEach(cargo => {
        if (cargo.sociedad === soc) out.push({ emp, cargo });
      });
    });
    return out;
  };

  // ---------- Per√≠odos / Workflow ----------
  const getPeriodoObj = (soc, periodo) => {
    if (!soc || !periodo) return null;
    let p = db.periodos.find(x => x.sociedad === soc && x.periodo === periodo);
    if (!p) {
      p = { sociedad: soc, periodo, estado: "abierto", bitacora: [], snapshotEnviado: null };
      db.periodos.push(p);
    }
    if (!p.estado) p.estado = "abierto";
    if (!Array.isArray(p.bitacora)) p.bitacora = [];
    return p;
  };

  const isPeriodoCerrado = (soc, periodo) => {
    const p = getPeriodoObj(soc, periodo);
    const hard = db.periodosCerrados.some(x => x.sociedad === soc && x.periodo === periodo);
    return hard || (p && p.estado === "cerrado");
  };

  const addPeriodoNota = (soc, periodo, nota) => {
    const p = getPeriodoObj(soc, periodo);
    if (!p) return;
    if (!nota) return;
    p.bitacora.unshift({ at: new Date().toISOString(), nota: String(nota).trim() });
    save();
  };

  const setPeriodoEstado = (soc, periodo, estado, nota = "") => {
    const p = getPeriodoObj(soc, periodo);
    if (!p) return;
    const estadoAnterior = p.estado;
    p.estado = estado;
    if (nota) p.bitacora.unshift({ at: new Date().toISOString(), nota: String(nota).trim() });

    // compat: lista de cierres
    if (estado === "cerrado" && !db.periodosCerrados.some(x => x.sociedad === soc && x.periodo === periodo)) {
      db.periodosCerrados.push({ sociedad: soc, periodo, cerradoAt: new Date().toISOString() });
    }
    if (estado !== "cerrado") {
      db.periodosCerrados = db.periodosCerrados.filter(x => !(x.sociedad === soc && x.periodo === periodo));
    }
    
    // Registrar en auditor√≠a
    if (estadoAnterior !== estado) {
      logAudit('periodo', {
        campo: `Estado per√≠odo ${periodo}`,
        valorAnterior: estadoAnterior || 'abierto',
        valorNuevo: estado,
        detalle: nota,
        accion: 'modificacion'
      });
    }
    
    save();
  };

  const cerrarPeriodo = (soc, periodo) => {
    if (!periodo) return false;
    setPeriodoEstado(soc, periodo, "cerrado", "Per√≠odo cerrado");
    return true;
  };

  const reabrirPeriodo = (soc, periodo) => {
    if (!periodo) return false;
    setPeriodoEstado(soc, periodo, "abierto", "Per√≠odo reabierto");
    return true;
  };

  // Dedup key for cargos imported (best-effort, pragmatic)
  const cargoKey = (c) =>
    [
      c.sociedad || "",
      (c.seccion || "").trim(),
      (c.cargo || "").trim(),
      String(c.horas ?? "").trim(),
      (c.nivel || "").trim(),
      (c.p1 || "").trim(),
      (c.p2 || "").trim(),
      (c.categoria || "").trim(),
      (c.fechaAltaCargo || "").trim(),
      (c.fechaBajaCargo || "").trim()
    ].join("|").toUpperCase();

  const addCargoIfNotExists = (emp, cargo) => {
    if (!Array.isArray(emp.cargos)) emp.cargos = [];
    const key = cargoKey(cargo);
    const exists = emp.cargos.some(x => cargoKey(x) === key);
    if (!exists) emp.cargos.push(cargo);
    return !exists;
  };

  // ---------- Render ----------
  const renderDashboard = () => {
    const list = cargosEnSoc(currentSoc);
    const active = list.filter(x => (x.cargo.estado || "Activo") !== "Baja");
    const emps = new Set(active.map(x => x.emp.idEmpleado));
    $("mTotalEmp").textContent = emps.size;
    $("mCargosAct").textContent = active.length;
    $("mSocLabel").textContent = currentSoc;

    // Cargos por nivel (seg√∫n cargo.nivel, fallback a emp.nivel)
    const byNivel = { FORMACION: 0, SUPERIOR: 0, MEDIA: 0, OTROS: 0 };
    active.forEach(({ emp, cargo }) => {
      const n = normalizeNivel(cargo.nivel || emp.nivel || "");
      if (n === "FORMACION") byNivel.FORMACION++;
      else if (n === "SUPERIOR") byNivel.SUPERIOR++;
      else if (n === "MEDIA") byNivel.MEDIA++;
      else byNivel.OTROS++;
    });
    $("mCargosForm") && ($("mCargosForm").textContent = byNivel.FORMACION);
    $("mCargosSup") && ($("mCargosSup").textContent = byNivel.SUPERIOR);
    $("mCargosMed") && ($("mCargosMed").textContent = byNivel.MEDIA);
  };

  const renderEmpleados = () => {
    const q = toUpper($("searchEmp")?.value || "");
    const tb = $("tbodyEmp");
    const list = cargosEnSoc(currentSoc).filter(x =>
      toUpper(x.emp.apellidoNombre).includes(q) || normCuil(x.emp.cuil).includes(normCuil(q))
    );

    tb.innerHTML = list.length
      ? list.map(({ emp, cargo }) => `
        <tr>
          <td>${cargo.seccion || "-"}</td>
          <td>${formatCuil(emp.cuil)}</td>
          <td><b>${emp.apellidoNombre || "-"}</b></td>
          <td>${cargo.cargo || "-"}</td>
          <td>${cargo.horas ?? "-"}</td>
          <td>${cargo.estado || "Activo"}</td>
          <td style="white-space:nowrap"><button class="btn" data-act="editEmp" data-emp="${emp.idEmpleado}" data-cargo="${cargo.idCargo}">Editar</button> <button class="btn danger" data-act="delCargo" data-emp="${emp.idEmpleado}" data-cargo="${cargo.idCargo}">Eliminar</button></td>
        </tr>
      `).join("")
      : `<tr><td colspan="7">No hay datos.</td></tr>`;
  };

  const cargoMatches = (cargoObj, rowInfo) => {
    const norm = (x) => toUpper(x).replace(/\s+/g," ").trim();
    const c1 = norm(cargoObj?.cargo || "");
    const p1 = norm(cargoObj?.p1 || "");
    const p2 = norm(cargoObj?.p2 || "");
    const se = norm(cargoObj?.seccion || "");
    const wantCargo = norm(rowInfo?.cargo || "");
    const wantP1 = norm(rowInfo?.p1 || "");
    const wantP2 = norm(rowInfo?.p2 || "");
    const wantSec = norm(rowInfo?.seccion || "");
    // Prioridad: P1/P2 si est√°n
    if (wantP1 && p1 && wantP1 === p1) return true;
    if (wantP2 && p2 && wantP2 === p2) return true;
    // Luego cargo/secci√≥n
    if (wantCargo && c1 && (c1 === wantCargo || c1.includes(wantCargo) || wantCargo.includes(c1))) {
      if (!wantSec) return true;
      if (se && (se === wantSec || se.includes(wantSec) || wantSec.includes(se))) return true;
      // si no matchea secci√≥n pero cargo matchea, igual aceptamos
      return true;
    }
    return false;
  };

  const findCargoFor = (emp, soc, rowInfo) => {
    const cargos = (emp?.cargos || []).filter(c => c.sociedad === soc && (c.estado || "Activo") !== "Baja");
    if (!cargos.length) return null;
    const hit = cargos.find(c => cargoMatches(c, rowInfo));
    return hit || cargos[0];
  };

  const novOrigenTxt = (n) => {
    const o = n.origen || null;
    if (!o) return "";
    const parts = [];
    if (o.file) parts.push(o.file);
    if (o.sheet) parts.push(o.sheet);
    if (o.row) parts.push(`fila ${o.row}`);
    return parts.join(" ‚Ä¢ ");
  };

  const computeNovAlerts = (soc, period) => {
    const novs = db.novedades.filter(n => n.sociedad === soc && n.periodo === period);
    let missingEmp = 0, missingCargo = 0, invalid = 0;
    novs.forEach(n => {
      const e = db.empleados.find(x => x.idEmpleado === n.idEmpleado);
      if (!e) missingEmp++;
      if (!n.idCargo) missingCargo++;
      if (!n.tipo || (!n.valor && String(n.valor||"") !== "0")) invalid++;
    });
    return { total: novs.length, missingEmp, missingCargo, invalid };
  };

  const renderPeriodoUI = () => {
    const period = $("novPeriodo")?.value || "";
    const pill = $("periodoEstadoTxt");
    const bit = $("periodoBitacora");
    const hint = $("novAlertsHint");
    if (!period) return;

    const p = getPeriodoObj(currentSoc, period) || { estado: "abierto", bitacora: [] };
    if (pill) pill.textContent = p.estado || "abierto";
    if (bit) {
      const lines = (p.bitacora || []).slice(0, 12).map(x => `‚Ä¢ ${new Date(x.at).toLocaleString()} ‚Äî ${x.nota}`);
      bit.textContent = lines.length ? lines.join("\n") : "Sin notas.";
    }
    if (hint) {
      const a = computeNovAlerts(currentSoc, period);
      const parts = [];
      if (a.missingEmp) parts.push(`empleado no encontrado: ${a.missingEmp}`);
      if (a.missingCargo) parts.push(`sin cargo asociado: ${a.missingCargo}`);
      if (a.invalid) parts.push(`incompletas: ${a.invalid}`);
      hint.textContent = parts.length ? `Alertas: ${parts.join(" ‚Ä¢ ")}` : "";
    }

    const closed = isPeriodoCerrado(currentSoc, period);
    // Toggle buttons
    const disableIfClosed = ["btnAddNov","btnNovImpImport"].map(id => $(id)).filter(Boolean);
    disableIfClosed.forEach(b => b.disabled = closed || b.disabled && b.id==="btnNovImpImport");
  };

  const renderNovedades = () => {
    const period = $("novPeriodo")?.value || "";
    const tb = $("tbodyNov");
    const selEmp = $("novEmpSelect");
    const selCargo = $("novCargoSelect");

    // Employees eligible for society
    const emps = empleadosConCargoEnSoc(currentSoc).sort((a,b) => (a.apellidoNombre||"").localeCompare(b.apellidoNombre||""));
    if (selEmp) {
      const cur = selEmp.value || "";
      selEmp.innerHTML =
        `<option value="">Seleccionar...</option>` +
        emps.map(e => `<option value="${e.idEmpleado}">${e.apellidoNombre} ‚Äî ${formatCuil(e.cuil)}</option>`).join("");
      if (cur && emps.some(e=>e.idEmpleado===cur)) selEmp.value = cur;
    }

    // Cargo select depends on employee
    const emp = db.empleados.find(e => e.idEmpleado === (selEmp?.value || ""));
    const cargos = (emp?.cargos || []).filter(c => c.sociedad === currentSoc && (c.estado||"Activo")!=="Baja");
    if (selCargo) {
      const curC = selCargo.value || "";
      selCargo.innerHTML = `<option value="">(Sin cargo)</option>` + cargos.map(c => {
        const label = `${c.seccion || ""} ‚Ä¢ ${c.cargo || c.p1 || ""} ‚Ä¢ ${c.horas || ""}hs`;
        return `<option value="${c.idCargo}">${label.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}</option>`;
      }).join("");
      if (curC && cargos.some(c=>c.idCargo===curC)) selCargo.value = curC;
    }

    const novs = db.novedades
      .filter(n => n.periodo === period && n.sociedad === currentSoc)
      .sort((a,b) => (a.tipo||"").localeCompare(b.tipo||""));

    tb.innerHTML = novs.length ? novs.map(n => {
      const e = db.empleados.find(x => x.idEmpleado === n.idEmpleado);
      const c = e?.cargos?.find(x => x.idCargo === n.idCargo);
      const empTxt = e ? `${e.apellidoNombre} ‚Äî ${formatCuil(e.cuil)}` : "Empleado no encontrado";
      const cargoTxt = c ? `${c.seccion||""} ‚Ä¢ ${c.cargo||c.p1||""}` : (n.idCargo ? "Cargo no encontrado" : "‚Äî");
      const det = (n.detalle || "").toString();
      const est = n.estado || "cargada";
      return `<tr>
        <td>${n.periodo || ""}</td>
        <td>${empTxt}</td>
        <td>${cargoTxt}</td>
        <td>${n.tipo || ""}</td>
        <td>${(n.valor ?? "")}</td>
        <td>${det}</td>
        <td>${est}</td>
        <td>${novOrigenTxt(n)}</td>
        <td>
          <button class="btn" data-act="toggleNovEstado" data-nov="${n.idNovedad}">Aplicada</button>
          <button class="btn danger" data-act="delNov" data-nov="${n.idNovedad}">Eliminar</button>
        </td>
      </tr>`;
    }).join("") : `<tr><td colspan="9">Sin novedades para este per√≠odo.</td></tr>`;

    renderPeriodoUI();
  };

  // ---------- ANTIG√úEDADES: L√≥gica y Renderizado ----------

  // Calcular alertas de antig√ºedad para un empleado
  const calcAntiguedadAlertas = (emp, soc) => {
    ensureEmpHist(emp);
    const alertas = [];
    const fechaAltaEstab = (emp.estabBySoc?.[soc]?.fechaAltaEstab || "").trim();
    
    // Alerta cr√≠tica: sin fecha de alta
    if (!fechaAltaEstab) {
      alertas.push({ tipo: "error", msg: "Sin fecha de alta al establecimiento" });
      return { alertas, nivel: "error" };
    }

    const fechaAltaDate = parseDateFlexible(fechaAltaEstab);
    if (!fechaAltaDate) {
      alertas.push({ tipo: "error", msg: "Fecha de alta inv√°lida: " + fechaAltaEstab });
      return { alertas, nivel: "error" };
    }

    // Verificar cargos
    const cargos = (emp.cargos || []).filter(c => c.sociedad === soc && (c.estado || "Activo") !== "Baja");
    
    cargos.forEach(cargo => {
      const fechaAltaCargo = parseDateFlexible(cargo.fechaAltaCargo);
      if (fechaAltaCargo && fechaAltaDate > fechaAltaCargo) {
        alertas.push({ 
          tipo: "warning", 
          msg: `Fecha alta estab (${toDDMMYYYY(fechaAltaEstab)}) posterior a alta cargo (${toDDMMYYYY(cargo.fechaAltaCargo)})` 
        });
      }
    });

    // Verificar huecos en historial
    const hist = emp.historialPeriodos.filter(p => (p?.sociedad || "") === soc);
    if (hist.length > 1) {
      const sorted = hist.slice().sort((a,b) => {
        const da = parseDateFlexible(a.inicio);
        const db = parseDateFlexible(b.inicio);
        return (da?.getTime() || 0) - (db?.getTime() || 0);
      });
      for (let i = 1; i < sorted.length; i++) {
        const finAnterior = parseDateFlexible(sorted[i-1].fin);
        const inicioActual = parseDateFlexible(sorted[i].inicio);
        if (finAnterior && inicioActual) {
          const diffDays = Math.floor((inicioActual - finAnterior) / 86400000);
          if (diffDays > 1) {
            alertas.push({ 
              tipo: "warning", 
              msg: `Hueco de ${diffDays} d√≠as en historial (${toDDMMYYYY(sorted[i-1].fin)} ‚Üí ${toDDMMYYYY(sorted[i].inicio)})` 
            });
          }
        }
      }
    }

    // Verificar antig√ºedad muy alta o negativa
    const dias = antiguedadDias(emp, soc);
    if (dias < 0) {
      alertas.push({ tipo: "error", msg: "Antig√ºedad negativa calculada" });
    } else if (dias > 365 * 50) {
      alertas.push({ tipo: "warning", msg: "Antig√ºedad > 50 a√±os - verificar" });
    }

    const nivel = alertas.some(a => a.tipo === "error") ? "error" : 
                  alertas.length > 0 ? "warning" : "ok";
    return { alertas, nivel };
  };

  // Formatear antig√ºedad en a√±os/meses/d√≠as
  const formatAntiguedad = (dias) => {
    if (dias <= 0) return "0 d√≠as";
    const years = Math.floor(dias / 365);
    const months = Math.floor((dias % 365) / 30);
    const days = dias % 30;
    const parts = [];
    if (years > 0) parts.push(`${years}a`);
    if (months > 0) parts.push(`${months}m`);
    if (days > 0 || parts.length === 0) parts.push(`${days}d`);
    return parts.join(" ") + ` (${dias} d√≠as)`;
  };

  // Estado de antig√ºedades para comparador
  let antCompHeaders = [];
  let antCompRows = [];
  let antCompMap = {};

  // Renderizar Dashboard de Antig√ºedades
  const renderAntiguedades = () => {
    const q = toUpper($("searchAnt")?.value || "");
    const soloAlertas = $("antSoloAlertas")?.checked || false;
    const tb = $("tbodyAnt");
    
    // Obtener empleados √∫nicos con cargos en la sociedad
    const empsSet = new Map();
    cargosEnSoc(currentSoc).forEach(({ emp }) => {
      if (!empsSet.has(emp.idEmpleado)) {
        empsSet.set(emp.idEmpleado, emp);
      }
    });
    
    let emps = Array.from(empsSet.values());
    
    // Filtrar por b√∫squeda
    if (q) {
      emps = emps.filter(e => 
        toUpper(e.apellidoNombre).includes(q) || normCuil(e.cuil).includes(normCuil(q))
      );
    }
    
    // Calcular alertas y ordenar
    const empsConAlertas = emps.map(emp => {
      const { alertas, nivel } = calcAntiguedadAlertas(emp, currentSoc);
      const dias = antiguedadDias(emp, currentSoc);
      const fechaAlta = (emp.estabBySoc?.[currentSoc]?.fechaAltaEstab || "").trim();
      return { emp, alertas, nivel, dias, fechaAlta };
    });
    
    // Filtrar solo alertas si est√° marcado
    const filtered = soloAlertas 
      ? empsConAlertas.filter(x => x.nivel !== "ok")
      : empsConAlertas;
    
    // Ordenar: errores primero, luego warnings, luego ok
    filtered.sort((a, b) => {
      const orden = { error: 0, warning: 1, ok: 2 };
      if (orden[a.nivel] !== orden[b.nivel]) return orden[a.nivel] - orden[b.nivel];
      return (a.emp.apellidoNombre || "").localeCompare(b.emp.apellidoNombre || "");
    });
    
    // Actualizar m√©tricas
    const totalEmps = empsConAlertas.length;
    const sinAlertas = empsConAlertas.filter(x => x.nivel === "ok").length;
    const conAlertas = empsConAlertas.filter(x => x.nivel === "warning").length;
    const sinFecha = empsConAlertas.filter(x => x.nivel === "error").length;
    
    $("antTotalEmp").textContent = totalEmps;
    $("antSinAlertas").textContent = sinAlertas;
    $("antConAlertas").textContent = conAlertas;
    $("antSinFecha").textContent = sinFecha;
    
    // Renderizar tabla
    if (!filtered.length) {
      tb.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:#666">
        ${soloAlertas ? "No hay empleados con alertas" : "No hay empleados en esta sociedad"}
      </td></tr>`;
      return;
    }
    
    tb.innerHTML = filtered.map(({ emp, alertas, nivel, dias, fechaAlta }) => {
      const statusColor = nivel === "ok" ? "#059669" : nivel === "warning" ? "#d97706" : "#dc2626";
      const statusIcon = nivel === "ok" ? "‚úì" : nivel === "warning" ? "‚ö†" : "‚úó";
      const alertasHtml = alertas.length 
        ? alertas.map(a => `<div style="font-size:12px; color:${a.tipo === 'error' ? '#dc2626' : '#d97706'}">‚Ä¢ ${escapeHtml(a.msg)}</div>`).join("")
        : '<span style="color:#059669; font-size:12px">Sin alertas</span>';
      
      return `
        <tr>
          <td style="text-align:center">
            <span style="display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; background:${statusColor}; color:#fff; border-radius:50%; font-weight:bold; font-size:14px">${statusIcon}</span>
          </td>
          <td>${formatCuil(emp.cuil)}</td>
          <td><b>${escapeHtml(emp.apellidoNombre || "-")}</b></td>
          <td>${fechaAlta ? toDDMMYYYY(fechaAlta) : '<span style="color:#dc2626; font-weight:bold">NO CARGADA</span>'}</td>
          <td style="font-family:monospace; font-size:13px">${formatAntiguedad(dias)}</td>
          <td>${alertasHtml}</td>
          <td>
            <button class="btn" data-act="editAntEmp" data-emp="${emp.idEmpleado}">Editar</button>
            <button class="btn" data-act="verHistorial" data-emp="${emp.idEmpleado}">Historial</button>
          </td>
        </tr>
      `;
    }).join("");
  };

  // Exportar antig√ºedades a XLSX
  const exportAntiguedadesXlsx = () => {
    const empsSet = new Map();
    cargosEnSoc(currentSoc).forEach(({ emp }) => {
      if (!empsSet.has(emp.idEmpleado)) empsSet.set(emp.idEmpleado, emp);
    });
    
    const rows = Array.from(empsSet.values()).map(emp => {
      const { alertas, nivel } = calcAntiguedadAlertas(emp, currentSoc);
      const dias = antiguedadDias(emp, currentSoc);
      const fechaAlta = (emp.estabBySoc?.[currentSoc]?.fechaAltaEstab || "").trim();
      const hist = emp.historialPeriodos.filter(p => (p?.sociedad || "") === currentSoc);
      
      return {
        "CUIL": formatCuil(emp.cuil),
        "Apellido y Nombre": emp.apellidoNombre || "",
        "Fecha Alta Establecimiento": fechaAlta ? toDDMMYYYY(fechaAlta) : "",
        "Antig√ºedad (d√≠as)": dias,
        "Antig√ºedad (a√±os)": Math.round(dias / 365 * 100) / 100,
        "Per√≠odos Hist√≥ricos": hist.length,
        "Estado": nivel === "ok" ? "OK" : nivel === "warning" ? "ALERTA" : "ERROR",
        "Alertas": alertas.map(a => a.msg).join(" | "),
        "Sociedad": currentSoc
      };
    });
    
    rows.sort((a, b) => (a["Apellido y Nombre"] || "").localeCompare(b["Apellido y Nombre"] || ""));
    
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Antig√ºedades");
    XLSX.writeFile(wb, `Antiguedades_${currentSoc}_${new Date().toISOString().slice(0,10)}.xlsx`);
    toast("Antig√ºedades exportadas");
  };

  // Comparador de antig√ºedades
  const toggleComparador = (show) => {
    const panel = $("antComparadorPanel");
    if (panel) panel.style.display = show ? "block" : "none";
    if (!show) {
      antCompHeaders = [];
      antCompRows = [];
      antCompMap = {};
      $("antCompPreview").textContent = "Esperando archivo‚Ä¶";
      $("antCompMapGrid").innerHTML = "";
      $("antCompResultWrap").innerHTML = "";
      $("btnAntCompAnalyze").disabled = true;
    }
  };

  const detectAntCompColumns = async () => {
    const f = $("antCompFile")?.files?.[0];
    if (!f) return toast("Eleg√≠ un archivo");
    
    try { antCompRows = await readRowsFromFile(f); }
    catch { antCompRows = []; antCompHeaders = []; return toast("No pude leer el archivo"); }
    
    if (!antCompRows.length) return toast("Archivo vac√≠o");
    
    const set = new Set();
    antCompRows.slice(0, 50).forEach(r => Object.keys(r || {}).forEach(k => set.add(k)));
    antCompHeaders = Array.from(set);
    
    // Auto-mapeo
    antCompMap = {
      cuil: guessHeader(antCompHeaders, ["CUIL", "CUIL/CUIT", "CUIT", "C.U.I.L."]),
      apellidoNombre: guessHeader(antCompHeaders, ["APELLIDO Y NOMBRE", "APELLIDO NOMBRE", "Apellido y Nombre"]),
      antigDias: guessHeader(antCompHeaders, ["ANTIGUEDAD", "ANTIG", "DIAS", "ANTIGUEDAD DIAS", "Antig√ºedad"]),
      fechaAltaEstab: guessHeader(antCompHeaders, ["FECHA ALTA", "FECHA DE ALTA", "ALTA ESTAB", "ALTA AL ESTABL"])
    };
    
    renderAntCompMappingUI();
  };

  const renderAntCompMappingUI = () => {
    const grid = $("antCompMapGrid");
    const preview = $("antCompPreview");
    const btnAnalyze = $("btnAntCompAnalyze");
    
    if (!antCompHeaders.length) {
      preview.textContent = "Esperando archivo‚Ä¶";
      grid.innerHTML = "";
      btnAnalyze.disabled = true;
      return;
    }
    
    const buildSel = (id, label, value) => {
      const opts = ['<option value="">(Sin asignar)</option>']
        .concat(antCompHeaders.map(h => `<option value="${escapeHtml(h)}" ${h===value?'selected':''}>${escapeHtml(h)}</option>`))
        .join("");
      return `<label style="min-width:200px">${label}<select data-antmap="${id}">${opts}</select></label>`;
    };
    
    grid.innerHTML = [
      buildSel("cuil", "CUIL *", antCompMap.cuil),
      buildSel("antigDias", "Antig√ºedad (d√≠as)", antCompMap.antigDias),
      buildSel("fechaAltaEstab", "Fecha Alta Estab.", antCompMap.fechaAltaEstab),
      buildSel("apellidoNombre", "Apellido y Nombre", antCompMap.apellidoNombre)
    ].join("");
    
    const hasCuil = Boolean(antCompMap.cuil);
    const hasAntig = Boolean(antCompMap.antigDias || antCompMap.fechaAltaEstab);
    btnAnalyze.disabled = !(hasCuil && hasAntig);
    
    preview.textContent = `${antCompRows.length} filas detectadas. ` + 
      (hasCuil && hasAntig ? "Listo para analizar." : "Asign√° CUIL y al menos Antig√ºedad o Fecha Alta.");
  };

  const analyzeAntComp = () => {
    if (!antCompRows.length) return toast("No hay datos cargados");
    
    const diffs = [];
    const getCell = (row, col) => row?.[col] ?? "";
    
    antCompRows.forEach((row, idx) => {
      const cuilRaw = getCell(row, antCompMap.cuil);
      const cuil = normCuil(cuilRaw);
      if (!cuil || cuil.length < 8) return;
      
      const emp = db.empleados.find(e => normCuil(e.cuil) === cuil);
      if (!emp) {
        diffs.push({
          cuil: formatCuil(cuil),
          nombre: getCell(row, antCompMap.apellidoNombre) || "(no encontrado)",
          campo: "Empleado",
          sistema: "NO EXISTE",
          liquidador: "En planilla",
          diferencia: "Empleado no encontrado en el sistema"
        });
        return;
      }
      
      // Comparar antig√ºedad en d√≠as
      if (antCompMap.antigDias) {
        const liqDias = toNum(getCell(row, antCompMap.antigDias));
        const sysDias = antiguedadDias(emp, currentSoc);
        if (liqDias > 0 && Math.abs(sysDias - liqDias) > 1) {
          diffs.push({
            cuil: formatCuil(emp.cuil),
            nombre: emp.apellidoNombre || "",
            campo: "Antig√ºedad (d√≠as)",
            sistema: String(sysDias),
            liquidador: String(liqDias),
            diferencia: sysDias - liqDias > 0 ? `+${sysDias - liqDias}` : String(sysDias - liqDias)
          });
        }
      }
      
      // Comparar fecha de alta
      if (antCompMap.fechaAltaEstab) {
        const liqFecha = toDDMMYYYY(getCell(row, antCompMap.fechaAltaEstab));
        const sysFecha = toDDMMYYYY(emp.estabBySoc?.[currentSoc]?.fechaAltaEstab || "");
        if (liqFecha && sysFecha && liqFecha !== sysFecha) {
          diffs.push({
            cuil: formatCuil(emp.cuil),
            nombre: emp.apellidoNombre || "",
            campo: "Fecha Alta Estab.",
            sistema: sysFecha,
            liquidador: liqFecha,
            diferencia: "Fechas distintas"
          });
        }
      }
    });
    
    // Renderizar resultados
    const wrap = $("antCompResultWrap");
    if (!diffs.length) {
      wrap.innerHTML = `<div class="hint" style="background:#059669; color:#fff; padding:16px; border-radius:12px; text-align:center">
        <b>‚úì Sin diferencias detectadas</b><br>Las antig√ºedades del sistema coinciden con la planilla del liquidador.
      </div>`;
      toast("Sin diferencias");
      return;
    }
    
    const rows = diffs.map(d => `
      <tr>
        <td>${escapeHtml(d.cuil)}</td>
        <td>${escapeHtml(d.nombre)}</td>
        <td>${escapeHtml(d.campo)}</td>
        <td style="font-family:monospace">${escapeHtml(d.sistema)}</td>
        <td style="font-family:monospace">${escapeHtml(d.liquidador)}</td>
        <td style="font-weight:bold; color:${d.diferencia.startsWith('+') ? '#059669' : d.diferencia.startsWith('-') ? '#dc2626' : '#d97706'}">${escapeHtml(d.diferencia)}</td>
      </tr>
    `).join("");
    
    wrap.innerHTML = `
      <div class="hint" style="background:#fef3c7; border:1px solid #d97706; padding:12px; border-radius:10px; margin-bottom:12px">
        <b>‚ö† Se encontraron ${diffs.length} diferencias</b>
      </div>
      <div class="controls" style="margin-bottom:10px">
        <button class="btn" id="btnExportDiffsAnt">Exportar diferencias (CSV)</button>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>CUIL</th><th>Nombre</th><th>Campo</th><th>Sistema</th><th>Liquidador</th><th>Diferencia</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    
    // Evento para exportar
    $("btnExportDiffsAnt")?.addEventListener("click", () => {
      exportCSV(diffs, `diferencias_antiguedad_${currentSoc}_${new Date().toISOString().slice(0,10)}.csv`);
    });
    
    toast(`${diffs.length} diferencias encontradas`);
  };

  // Event listeners para mapeo del comparador
  document.addEventListener("change", (e) => {
    if (!e.target.dataset.antmap) return;
    const key = e.target.dataset.antmap;
    antCompMap[key] = e.target.value || "";
    renderAntCompMappingUI();
  });

  // ---------- AUDITOR√çA: Renderizado y funciones ----------

  const renderAuditoria = () => {
    const q = toUpper($("searchAud")?.value || "");
    const fechaDesde = $("audFechaDesde")?.value || "";
    const fechaHasta = $("audFechaHasta")?.value || "";
    const tipoCambio = $("audTipoCambio")?.value || "";
    const tb = $("tbodyAud");
    
    // Filtrar registros
    let registros = (db.auditoria || []).filter(r => r.sociedad === currentSoc);
    
    if (q) {
      registros = registros.filter(r => 
        toUpper(r.nombreEmpleado || "").includes(q) ||
        toUpper(r.campo || "").includes(q) ||
        toUpper(r.valorAnterior || "").includes(q) ||
        toUpper(r.valorNuevo || "").includes(q) ||
        toUpper(r.cuil || "").includes(q)
      );
    }
    
    if (fechaDesde) {
      const desde = new Date(fechaDesde);
      registros = registros.filter(r => new Date(r.timestamp) >= desde);
    }
    
    if (fechaHasta) {
      const hasta = new Date(fechaHasta + "T23:59:59");
      registros = registros.filter(r => new Date(r.timestamp) <= hasta);
    }
    
    if (tipoCambio) {
      registros = registros.filter(r => r.tipo === tipoCambio);
    }
    
    // Actualizar m√©tricas
    const ahora = new Date();
    const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
    const inicioSemana = new Date(hoy);
    inicioSemana.setDate(hoy.getDate() - hoy.getDay());
    const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
    
    const todosRegistros = (db.auditoria || []).filter(r => r.sociedad === currentSoc);
    $("audHoy").textContent = todosRegistros.filter(r => new Date(r.timestamp) >= hoy).length;
    $("audSemana").textContent = todosRegistros.filter(r => new Date(r.timestamp) >= inicioSemana).length;
    $("audMes").textContent = todosRegistros.filter(r => new Date(r.timestamp) >= inicioMes).length;
    $("audTotal").textContent = todosRegistros.length;
    
    // Paginaci√≥n
    const totalPaginas = Math.ceil(registros.length / audPorPagina) || 1;
    if (audPagina > totalPaginas) audPagina = totalPaginas;
    const inicio = (audPagina - 1) * audPorPagina;
    const paginados = registros.slice(inicio, inicio + audPorPagina);
    
    $("audPagInfo").textContent = `P√°gina ${audPagina} de ${totalPaginas} (${registros.length} registros)`;
    $("btnAudPrev").disabled = audPagina <= 1;
    $("btnAudNext").disabled = audPagina >= totalPaginas;
    
    // Renderizar tabla
    if (!paginados.length) {
      tb.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:#666">
        No hay registros de auditor√≠a${q || fechaDesde || fechaHasta || tipoCambio ? ' con los filtros aplicados' : ''}
      </td></tr>`;
      return;
    }
    
    const tipoColors = {
      empleado: '#0c4b3f',
      cargo: '#0891b2',
      novedad: '#7c3aed',
      periodo: '#d97706',
      importacion: '#059669',
      snapshot: '#dc2626'
    };
    
    const accionIcons = {
      creacion: '‚ûï',
      modificacion: '‚úèÔ∏è',
      eliminacion: 'üóëÔ∏è',
      importacion: 'üì•'
    };
    
    tb.innerHTML = paginados.map(r => {
      const fecha = new Date(r.timestamp);
      const fechaStr = fecha.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
      const horaStr = fecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
      const tipoColor = tipoColors[r.tipo] || '#666';
      const accionIcon = accionIcons[r.accion] || '‚Ä¢';
      
      return `
        <tr>
          <td style="font-family:monospace; font-size:12px; white-space:nowrap">${fechaStr}<br/>${horaStr}</td>
          <td><span style="display:inline-block; background:${tipoColor}; color:#fff; padding:3px 8px; border-radius:6px; font-size:11px; font-weight:bold">${accionIcon} ${(r.tipo || '').toUpperCase()}</span></td>
          <td>${r.nombreEmpleado ? `<b>${escapeHtml(r.nombreEmpleado)}</b><br/><span style="font-size:11px; color:#666">${formatCuil(r.cuil || '')}</span>` : '-'}</td>
          <td style="font-weight:600">${escapeHtml(r.campo || '-')}</td>
          <td style="font-family:monospace; font-size:12px; color:#dc2626; max-width:150px; overflow:hidden; text-overflow:ellipsis" title="${escapeHtml(r.valorAnterior || '')}">${escapeHtml(r.valorAnterior || '-')}</td>
          <td style="font-family:monospace; font-size:12px; color:#059669; max-width:150px; overflow:hidden; text-overflow:ellipsis" title="${escapeHtml(r.valorNuevo || '')}">${escapeHtml(r.valorNuevo || '-')}</td>
          <td style="font-size:12px; color:#666">${escapeHtml(r.detalle || '-')}</td>
        </tr>
      `;
    }).join("");
  };

  const exportAuditoria = () => {
    const registros = (db.auditoria || []).filter(r => r.sociedad === currentSoc);
    if (!registros.length) return toast("No hay registros para exportar");
    
    const rows = registros.map(r => ({
      "Fecha": new Date(r.timestamp).toLocaleDateString('es-AR'),
      "Hora": new Date(r.timestamp).toLocaleTimeString('es-AR'),
      "Tipo": r.tipo || "",
      "Acci√≥n": r.accion || "",
      "CUIL": formatCuil(r.cuil || ""),
      "Empleado": r.nombreEmpleado || "",
      "Campo": r.campo || "",
      "Valor Anterior": r.valorAnterior || "",
      "Valor Nuevo": r.valorNuevo || "",
      "Detalle": r.detalle || "",
      "Sociedad": r.sociedad || ""
    }));
    
    exportCSV(rows, `auditoria_${currentSoc}_${new Date().toISOString().slice(0,10)}.csv`);
    toast("Log de auditor√≠a exportado");
  };

  // ---------- SNAPSHOTS ----------
  
  const crearSnapshot = () => {
    const nombre = $("snapshotNombre")?.value.trim();
    if (!nombre) return toast("Ingres√° un nombre para el snapshot");
    
    const snapshot = {
      id: uid(),
      nombre,
      sociedad: currentSoc,
      timestamp: new Date().toISOString(),
      empleados: JSON.parse(JSON.stringify(
        db.empleados.filter(e => (e.cargos || []).some(c => c.sociedad === currentSoc))
      )),
      novedades: JSON.parse(JSON.stringify(
        db.novedades.filter(n => n.sociedad === currentSoc)
      ))
    };
    
    db.snapshots.unshift(snapshot);
    
    // Limitar a 20 snapshots
    if (db.snapshots.length > 20) {
      db.snapshots = db.snapshots.slice(0, 20);
    }
    
    logAudit('snapshot', {
      detalle: `Snapshot creado: ${nombre}`,
      accion: 'creacion'
    });
    
    save();
    $("snapshotNombre").value = "";
    renderSnapshots();
    toast("Snapshot creado");
  };

  const eliminarSnapshot = (id) => {
    if (!confirm("¬øEliminar este snapshot?")) return;
    db.snapshots = db.snapshots.filter(s => s.id !== id);
    save();
    renderSnapshots();
    toast("Snapshot eliminado");
  };

  const renderSnapshots = () => {
    const wrap = $("snapshotsListWrap");
    if (!wrap) return;
    
    const snaps = (db.snapshots || []).filter(s => s.sociedad === currentSoc);
    
    if (!snaps.length) {
      wrap.innerHTML = '<div class="hint">No hay snapshots guardados para esta sociedad.</div>';
      return;
    }
    
    wrap.innerHTML = `
      <table style="width:100%; border-collapse:collapse; font-size:13px">
        <thead>
          <tr style="background:rgba(12,75,63,.06)">
            <th style="padding:8px; text-align:left">Nombre</th>
            <th style="padding:8px; text-align:left">Fecha</th>
            <th style="padding:8px; text-align:left">Empleados</th>
            <th style="padding:8px; text-align:left">Novedades</th>
            <th style="padding:8px; text-align:left">Acciones</th>
          </tr>
        </thead>
        <tbody>
          ${snaps.map(s => `
            <tr style="border-bottom:1px solid rgba(0,0,0,.06)">
              <td style="padding:8px; font-weight:600">${escapeHtml(s.nombre)}</td>
              <td style="padding:8px">${new Date(s.timestamp).toLocaleString('es-AR')}</td>
              <td style="padding:8px">${(s.empleados || []).length}</td>
              <td style="padding:8px">${(s.novedades || []).length}</td>
              <td style="padding:8px">
                <button class="btn" data-act="compararSnapshot" data-snap="${s.id}" style="font-size:11px; padding:5px 10px">Comparar con actual</button>
                <button class="btn danger" data-act="eliminarSnapshot" data-snap="${s.id}" style="font-size:11px; padding:5px 10px">Eliminar</button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  };

  const compararConSnapshot = (snapId) => {
    const snap = db.snapshots.find(s => s.id === snapId);
    if (!snap) return toast("Snapshot no encontrado");
    
    const diffs = [];
    const snapEmps = new Map((snap.empleados || []).map(e => [normCuil(e.cuil), e]));
    const currEmps = new Map(
      db.empleados
        .filter(e => (e.cargos || []).some(c => c.sociedad === currentSoc))
        .map(e => [normCuil(e.cuil), e])
    );
    
    // Empleados nuevos (en actual pero no en snapshot)
    currEmps.forEach((emp, cuil) => {
      if (!snapEmps.has(cuil)) {
        diffs.push({
          tipo: 'NUEVO',
          cuil: formatCuil(cuil),
          nombre: emp.apellidoNombre || '',
          campo: 'Empleado',
          valorSnap: '(no exist√≠a)',
          valorActual: 'Agregado'
        });
      }
    });
    
    // Empleados eliminados o modificados
    snapEmps.forEach((snapEmp, cuil) => {
      const currEmp = currEmps.get(cuil);
      if (!currEmp) {
        diffs.push({
          tipo: 'ELIMINADO',
          cuil: formatCuil(cuil),
          nombre: snapEmp.apellidoNombre || '',
          campo: 'Empleado',
          valorSnap: 'Exist√≠a',
          valorActual: '(eliminado)'
        });
        return;
      }
      
      // Comparar campos del empleado
      const camposEmp = ['apellidoNombre', 'nivel', 'sitRevista', 'escalafonAntiguedad'];
      camposEmp.forEach(campo => {
        const vSnap = String(snapEmp[campo] || '').trim();
        const vCurr = String(currEmp[campo] || '').trim();
        if (vSnap !== vCurr) {
          diffs.push({
            tipo: 'MODIFICADO',
            cuil: formatCuil(cuil),
            nombre: currEmp.apellidoNombre || '',
            campo: campo,
            valorSnap: vSnap || '(vac√≠o)',
            valorActual: vCurr || '(vac√≠o)'
          });
        }
      });
      
      // Comparar cargos
      const snapCargos = (snapEmp.cargos || []).filter(c => c.sociedad === currentSoc);
      const currCargos = (currEmp.cargos || []).filter(c => c.sociedad === currentSoc);
      
      currCargos.forEach(cc => {
        const sc = snapCargos.find(s => s.idCargo === cc.idCargo);
        if (!sc) {
          diffs.push({
            tipo: 'CARGO NUEVO',
            cuil: formatCuil(cuil),
            nombre: currEmp.apellidoNombre || '',
            campo: `Cargo: ${cc.cargo || cc.seccion || ''}`,
            valorSnap: '(no exist√≠a)',
            valorActual: `${cc.horas || '?'} hs`
          });
        } else {
          // Comparar horas
          if (String(sc.horas) !== String(cc.horas)) {
            diffs.push({
              tipo: 'MODIFICADO',
              cuil: formatCuil(cuil),
              nombre: currEmp.apellidoNombre || '',
              campo: `Horas (${cc.cargo || cc.seccion || ''})`,
              valorSnap: String(sc.horas || '0'),
              valorActual: String(cc.horas || '0')
            });
          }
        }
      });
    });
    
    // Mostrar resultados
    const wrap = $("compResultWrap");
    if (!diffs.length) {
      wrap.innerHTML = `<div class="hint" style="background:#059669; color:#fff; padding:16px; border-radius:12px; text-align:center">
        <b>‚úì Sin diferencias</b><br>El estado actual coincide con el snapshot "${escapeHtml(snap.nombre)}"
      </div>`;
      return;
    }
    
    wrap.innerHTML = `
      <div class="hint" style="background:#fef3c7; border:1px solid #d97706; padding:12px; border-radius:10px; margin-bottom:12px">
        <b>Comparaci√≥n con snapshot "${escapeHtml(snap.nombre)}":</b> ${diffs.length} diferencias encontradas
      </div>
      <div class="tableWrap" style="max-height:400px; overflow:auto">
        <table>
          <thead>
            <tr><th>Tipo</th><th>CUIL</th><th>Nombre</th><th>Campo</th><th>En Snapshot</th><th>Actual</th></tr>
          </thead>
          <tbody>
            ${diffs.map(d => `
              <tr>
                <td><span style="background:${d.tipo === 'NUEVO' ? '#059669' : d.tipo === 'ELIMINADO' ? '#dc2626' : '#d97706'}; color:#fff; padding:2px 6px; border-radius:4px; font-size:10px">${d.tipo}</span></td>
                <td>${escapeHtml(d.cuil)}</td>
                <td>${escapeHtml(d.nombre)}</td>
                <td>${escapeHtml(d.campo)}</td>
                <td style="font-family:monospace; font-size:12px">${escapeHtml(d.valorSnap)}</td>
                <td style="font-family:monospace; font-size:12px">${escapeHtml(d.valorActual)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
  };

  // ---------- COMPARADOR MES A MES ----------
  
  let compResultData = [];
  
  const compararPeriodos = () => {
    const periodoBase = $("compPeriodoBase")?.value;
    const periodoComp = $("compPeriodoComp")?.value;
    
    if (!periodoBase || !periodoComp) return toast("Seleccion√° ambos per√≠odos");
    if (periodoBase === periodoComp) return toast("Los per√≠odos deben ser diferentes");
    
    // Obtener novedades de cada per√≠odo
    const novsBase = db.novedades.filter(n => n.sociedad === currentSoc && n.periodo === periodoBase);
    const novsComp = db.novedades.filter(n => n.sociedad === currentSoc && n.periodo === periodoComp);
    
    const diffs = [];
    
    // Agrupar por empleado
    const empIdsBase = new Set(novsBase.map(n => n.idEmpleado));
    const empIdsComp = new Set(novsComp.map(n => n.idEmpleado));
    const allEmpIds = new Set([...empIdsBase, ...empIdsComp]);
    
    allEmpIds.forEach(idEmp => {
      const emp = db.empleados.find(e => e.idEmpleado === idEmp);
      if (!emp) return;
      
      const novsEmpBase = novsBase.filter(n => n.idEmpleado === idEmp);
      const novsEmpComp = novsComp.filter(n => n.idEmpleado === idEmp);
      
      // Contar por tipo
      const countByTipo = (novs, tipo) => novs.filter(n => toUpper(n.tipo || '').includes(tipo)).reduce((sum, n) => sum + toNum(n.valor), 0);
      
      const descBase = countByTipo(novsEmpBase, 'DTO') + countByTipo(novsEmpBase, 'DESCUENTO');
      const descComp = countByTipo(novsEmpComp, 'DTO') + countByTipo(novsEmpComp, 'DESCUENTO');
      
      const licBase = novsEmpBase.filter(n => toUpper(n.tipo || '').includes('LICENCIA')).length;
      const licComp = novsEmpComp.filter(n => toUpper(n.tipo || '').includes('LICENCIA')).length;
      
      if (descBase !== descComp || licBase !== licComp || novsEmpBase.length !== novsEmpComp.length) {
        diffs.push({
          cuil: formatCuil(emp.cuil),
          nombre: emp.apellidoNombre || '',
          novsBase: novsEmpBase.length,
          novsComp: novsEmpComp.length,
          descBase,
          descComp,
          licBase,
          licComp,
          diffDesc: descComp - descBase,
          diffLic: licComp - licBase
        });
      }
    });
    
    // Empleados solo en un per√≠odo
    const empsOnlyBase = [...empIdsBase].filter(id => !empIdsComp.has(id));
    const empsOnlyComp = [...empIdsComp].filter(id => !empIdsBase.has(id));
    
    empsOnlyBase.forEach(idEmp => {
      const emp = db.empleados.find(e => e.idEmpleado === idEmp);
      if (emp) diffs.push({
        cuil: formatCuil(emp.cuil),
        nombre: emp.apellidoNombre || '',
        nota: `Solo en ${periodoBase}`
      });
    });
    
    empsOnlyComp.forEach(idEmp => {
      const emp = db.empleados.find(e => e.idEmpleado === idEmp);
      if (emp) diffs.push({
        cuil: formatCuil(emp.cuil),
        nombre: emp.apellidoNombre || '',
        nota: `Solo en ${periodoComp}`
      });
    });
    
    compResultData = diffs;
    $("btnExportComparacion").disabled = !diffs.length;
    
    const wrap = $("compResultWrap");
    if (!diffs.length) {
      wrap.innerHTML = `<div class="hint" style="background:#059669; color:#fff; padding:16px; border-radius:12px; text-align:center">
        <b>‚úì Sin diferencias</b><br>Las novedades de ${periodoBase} y ${periodoComp} son equivalentes
      </div>`;
      return;
    }
    
    wrap.innerHTML = `
      <div class="hint" style="margin-bottom:12px">
        Comparaci√≥n de <b>${periodoBase}</b> vs <b>${periodoComp}</b>: ${diffs.length} empleados con diferencias
      </div>
      <div class="tableWrap" style="max-height:400px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>CUIL</th><th>Nombre</th>
              <th>Nov. ${periodoBase}</th><th>Nov. ${periodoComp}</th>
              <th>Desc. ${periodoBase}</th><th>Desc. ${periodoComp}</th>
              <th>Nota</th>
            </tr>
          </thead>
          <tbody>
            ${diffs.map(d => `
              <tr>
                <td>${escapeHtml(d.cuil)}</td>
                <td>${escapeHtml(d.nombre)}</td>
                <td>${d.novsBase ?? '-'}</td>
                <td>${d.novsComp ?? '-'}</td>
                <td>${d.descBase ?? '-'}</td>
                <td>${d.descComp ?? '-'}</td>
                <td style="font-size:12px; color:#666">${escapeHtml(d.nota || (d.diffDesc ? `Œî desc: ${d.diffDesc > 0 ? '+' : ''}${d.diffDesc}` : ''))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
  };

  const exportComparacion = () => {
    if (!compResultData.length) return toast("No hay datos para exportar");
    exportCSV(compResultData, `comparacion_periodos_${currentSoc}_${new Date().toISOString().slice(0,10)}.csv`);
  };

  const exportCSV = (rows, filename) => {
    const esc = (v) => {
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    };
    const cols = rows.length ? Object.keys(rows[0]) : [];
    const csv = [cols.join(",")].concat(rows.map(r => cols.map(c => esc(r[c])).join(","))).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  };

  const exportEmpleadosCSV = () => {
    const list = cargosEnSoc(currentSoc).filter(x => (x.cargo.estado || "Activo") !== "Baja");
    if (!list.length) return toast("No hay cargos activos para exportar");
    const rows = list.map(({ emp, cargo }) => ({
      "Nivel": normalizeNivel(cargo.nivel || emp.nivel || ""),
      "Per": emp.per || "",
      "Subl": emp.subl || "",
      "nro - nombre seccion": cargo.nroNombreSeccion || cargo.seccion || "",
      "Apellido y Nombre": emp.apellidoNombre || "",
      "CUIL": formatCuil(emp.cuil || ""),
      "Sit. Revista": emp.sitRevista || cargo.sitRevista || "",
      "% jubilacion": emp.porcJubilacion || "",
      "Obra Social (CODIGO)": emp.obraSocialCodigo || "",
      "Obra Social (NOMBRE)": emp.obraSocialNombre || "",
      "Cargo": cargo.cargo || "",
      "P1": cargo.p1 || "",
      "P2": cargo.p2 || "",
      "Categor√≠a": cargo.categoria || "",
      "fecha de alta al establecimiento": emp.fechaAltaEstab || "",
      "Fecha de alta al cargo": cargo.fechaAltaCargo || "",
      "Fecha de Baja al cargo": cargo.fechaBajaCargo || "",
      "Horas": cargo.horas ?? "",
      "AA": cargo.aa || "",
      "MM": cargo.mm || "",
      "PORC": cargo.porc || "",
      "Escalada de Antiguedad": cargo.escaladaAntiguedad || emp.escaladaAntiguedad || "",
    }));
    exportCSV(rows, `empleados_${currentSoc}_${new Date().toISOString().slice(0,10)}.csv`);
  };

  const exportNovedadesLiquidador = () => {
    const period = $("novPeriodo")?.value || "";
    if (!period) return toast("Seleccion√° per√≠odo");
    const novs = db.novedades.filter(n => n.sociedad === currentSoc && n.periodo === period);
    const rows = novs.map(n => {
      const e = db.empleados.find(x => x.idEmpleado === n.idEmpleado) || {};
      const c = (e.cargos || []).find(x => x.idCargo === n.idCargo) || {};
      return {
        periodo: period,
        sociedad: currentSoc,
        cuil: formatCuil(e.cuil || ""),
        apellidoNombre: e.apellidoNombre || "",
        seccion: c.seccion || "",
        cargo: c.cargo || "",
        p1: c.p1 || "",
        p2: c.p2 || "",
        horasCargo: c.horas || "",
        tipo: n.tipo || "",
        valor: n.valor ?? "",
        detalle: n.detalle || "",
        fecha: n.fecha || "",
        estado: n.estado || "cargada",
      };
    });
    exportCSV(rows, `novedades_${currentSoc}_${period}_liquidador.csv`);
  };

  const exportNovedadesRevision = () => {
    const period = $("novPeriodo")?.value || "";
    if (!period) return toast("Seleccion√° per√≠odo");
    const novs = db.novedades.filter(n => n.sociedad === currentSoc && n.periodo === period);
    const byKey = new Map();
    const add = (k, obj) => byKey.set(k, { ...byKey.get(k), ...obj });

    novs.forEach(n => {
      const e = db.empleados.find(x => x.idEmpleado === n.idEmpleado) || {};
      const c = (e.cargos || []).find(x => x.idCargo === n.idCargo) || {};
      const k = `${n.idEmpleado}|${n.idCargo||""}`;
      if (!byKey.has(k)) byKey.set(k, {
        periodo: period,
        sociedad: currentSoc,
        cuil: formatCuil(e.cuil||""),
        apellidoNombre: e.apellidoNombre || "",
        seccion: c.seccion || "",
        cargo: c.cargo || c.p1 || "",
        horasCargo: toNum(c.horas || 0),
        descHoras: 0,
        horasExtra: 0,
        licencias: 0,
        bajas: 0,
        otros: 0,
      });
      const row = byKey.get(k);
      const t = toUpper(n.tipo);
      if (t.includes("DTO") || t.includes("DESCUENTO")) row.descHoras += toNum(n.valor);
      else if (t.includes("EXTRA")) row.horasExtra += toNum(n.valor);
      else if (t.includes("LICENCIA")) row.licencias += 1;
      else if (t.includes("BAJA")) row.bajas += 1;
      else row.otros += 1;
      byKey.set(k, row);
    });

    const rows = Array.from(byKey.values()).map(r => ({
      ...r,
      alerta_desc_mayor_horasCargo: (r.horasCargo && r.descHoras > r.horasCargo) ? "SI" : "",
    }));
    exportCSV(rows, `novedades_${currentSoc}_${period}_revision.csv`);
  };

  const diffConEnviado = () => {
    const period = $("novPeriodo")?.value || "";
    if (!period) return toast("Seleccion√° per√≠odo");
    const p = getPeriodoObj(currentSoc, period);
    if (!p?.snapshotEnviado) return toast("No hay snapshot 'enviado' para este per√≠odo");
    const cur = db.novedades.filter(n => n.sociedad === currentSoc && n.periodo === period);
    const key = (n) => `${n.idEmpleado}|${n.idCargo||""}|${n.tipo||""}|${String(n.valor??"")}|${n.detalle||""}|${n.fecha||""}`;
    const setSnap = new Set(p.snapshotEnviado.map(key));
    const setCur = new Set(cur.map(key));
    const added = cur.filter(n => !setSnap.has(key(n)));
    const removed = p.snapshotEnviado.filter(n => !setCur.has(key(n)));
    toast(`Cambios vs enviado: +${added.length} / -${removed.length}`);
    const rows = []
      .concat(added.map(n => ({ accion:"AGREGADA", periodo:n.periodo, tipo:n.tipo, valor:n.valor, detalle:n.detalle, idEmpleado:n.idEmpleado, idCargo:n.idCargo||"" })))
      .concat(removed.map(n => ({ accion:"ELIMINADA", periodo:n.periodo, tipo:n.tipo, valor:n.valor, detalle:n.detalle, idEmpleado:n.idEmpleado, idCargo:n.idCargo||"" })));
    if (rows.length) exportCSV(rows, `diff_enviado_${currentSoc}_${period}.csv`);
  };

  // ---------- Actions ----------
  const deleteCargo = (idEmpleado, idCargo) => {
    const e = db.empleados.find(x => x.idEmpleado === idEmpleado);
    if (!e) return;
    const cargo = (e.cargos || []).find(c => c.idCargo === idCargo);
    
    // Registrar en auditor√≠a antes de eliminar
    if (cargo) {
      logAudit('cargo', {
        idEmpleado,
        cuil: e.cuil,
        nombreEmpleado: e.apellidoNombre,
        idCargo,
        campo: 'Cargo eliminado',
        valorAnterior: `${cargo.seccion || ''} - ${cargo.cargo || ''} (${cargo.horas || '?'} hs)`,
        valorNuevo: '(eliminado)',
        accion: 'eliminacion'
      });
    }
    
    e.cargos = (e.cargos || []).filter(c => c.idCargo !== idCargo);
    save();
    renderEmpleados();
    renderDashboard();
    renderNovedades(); // por si cambia elegibilidad
  };

  const deleteNov = (idNovedad) => {
    const nov = db.novedades.find(n => n.idNovedad === idNovedad);
    
    // Registrar en auditor√≠a antes de eliminar
    if (nov) {
      const emp = db.empleados.find(e => e.idEmpleado === nov.idEmpleado);
      logAudit('novedad', {
        idEmpleado: nov.idEmpleado,
        cuil: emp?.cuil,
        nombreEmpleado: emp?.apellidoNombre,
        campo: nov.tipo,
        valorAnterior: `${nov.valor} - ${nov.detalle || ''}`,
        valorNuevo: '(eliminada)',
        detalle: `Per√≠odo: ${nov.periodo}`,
        accion: 'eliminacion'
      });
    }
    
    db.novedades = db.novedades.filter(n => n.idNovedad !== idNovedad);
    save();
    renderNovedades();
    toast("Novedad eliminada");
  };

  const exportNovedadesCSV = () => {
    const period = $("novPeriodo")?.value || "";
    if (!period) return toast("Seleccion√° un per√≠odo");
    const rows = db.novedades
      .filter(n => n.periodo === period && n.sociedad === currentSoc)
      .map(n => {
        const e = db.empleados.find(x => x.idEmpleado === n.idEmpleado);
        return {
          sociedad: currentSoc,
          periodo: n.periodo,
          cuil: e ? formatCuil(e.cuil) : "",
          nombre: e ? e.apellidoNombre : "",
          tipo: n.tipo,
          valor: n.valor
        };
      });

    const header = ["sociedad","periodo","cuil","nombre","tipo","valor"];
    const csv = [
      header.join(","),
      ...rows.map(r => header.map(k => `"${String(r[k] ?? "").replaceAll('"','""')}"`).join(","))
    ].join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `novedades_${currentSoc}_${period}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  };

  
  
  // ---------- Editor (Empleado + Cargo) ----------

  const renderEmpHistUI = (emp) => {
    ensureEmpHist(emp);
    const total = antiguedadDias(emp, currentSoc);
    const elTxt = $("empAntigTxt");
    if (elTxt) elTxt.textContent = `${total} d√≠as`;

    const elList = $("empHistList");
    if (!elList) return;

    const hist = emp.historialPeriodos.filter(p => (p?.sociedad || "") === currentSoc);
    if (!hist.length) {
      elList.innerHTML = `<div class="hint">Sin historial cargado para ${currentSoc}. (Se completa al dar de baja o manualmente.)</div>`;
      return;
    }

    const rows = hist
      .slice()
      .sort((a,b) => String(a.inicio).localeCompare(String(b.inicio)))
      .map(p => `<tr><td>${escapeHtml(p.inicio||"")}</td><td>${escapeHtml(p.fin||"")}</td></tr>`)
      .join("");

    elList.innerHTML = `
      <table class="table" style="margin-top:8px">
        <thead><tr><th>Inicio</th><th>Fin</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  };

  const closePeriodoActualEmp = (emp, finTxt) => {
    ensureEmpHist(emp);
    const inicio = (emp.estabBySoc?.[currentSoc]?.fechaAltaEstab || "").trim();
    if (!inicio) return toast("No hay per√≠odo actual para cerrar (falta fecha de alta al establecimiento)");
    const fin = toDDMMYYYY(finTxt || todayDDMMYYYY());
    // validaci√≥n simple
    if (daysBetweenInclusive(inicio, fin) <= 0) return toast("La fecha fin no puede ser anterior al inicio");

    emp.historialPeriodos.push({ sociedad: currentSoc, inicio: toDDMMYYYY(inicio), fin });
    emp.estabBySoc[currentSoc].fechaAltaEstab = ""; // queda en baja hasta nueva alta
  };

  const openEmpEditor = (idEmpleado, idCargo) => {
    const emp = db.empleados.find(e => e.idEmpleado === idEmpleado);
    const cargo = emp?.cargos?.find(c => c.idCargo === idCargo);
    if (!emp || !cargo) return toast("No pude abrir el editor");

    $("editEmpId").value = emp.idEmpleado;
    $("editCargoId").value = cargo.idCargo;

    $("empModalTitle").textContent = `Editar: ${emp.apellidoNombre || "(sin nombre)"} ‚Äî ${formatCuil(emp.cuil)}`;

    $("editCuil").value = normCuil(emp.cuil);
    $("editApellidoNombre").value = emp.apellidoNombre || "";
    $("editNivel").value = (toUpper(emp.nivel || cargo.nivel || "MEDIA") || "MEDIA");

    $("editPer").value = emp.per || "";
    $("editSubl").value = emp.subl || "";
    $("editSitRevista").value = emp.sitRevista || "";
    $("editPorcJub").value = emp.porcJubilacion || "";
    $("editObraSocial").value = emp.obraSocial || "";
    $("editEscAnt").value = emp.escalafonAntiguedad || "";
    ensureEmpHist(emp);
    const fechaAlta = (emp.estabBySoc?.[currentSoc]?.fechaAltaEstab || emp.fechaAltaEstab || "").trim();
    $("editFechaAltaEstab").value = fechaAlta;
    renderEmpHistUI(emp);

    $("editSeccion").value = cargo.seccion || "";
    $("editCargo").value = cargo.cargo || "";
    $("editCategoria").value = cargo.categoria || "";
    $("editP1").value = cargo.p1 || "";
    $("editP2").value = cargo.p2 || "";
    $("editHoras").value = cargo.horas ?? "";
    $("editAA").value = cargo.aa || "";
    $("editMM").value = cargo.mm || "";
    $("editPORC").value = cargo.porc || "";
    $("editFechaAltaCargo").value = cargo.fechaAltaCargo || "";
    $("editFechaBajaCargo").value = cargo.fechaBajaCargo || "";
    $("editEstado").value = cargo.estado || "Activo";

    const back = $("empModalBack");
    back.classList.add("show");
    back.setAttribute("aria-hidden", "false");
  };

  const closeEmpEditor = () => {
    const back = $("empModalBack");
    back.classList.remove("show");
    back.setAttribute("aria-hidden", "true");
  };

  const saveEmpEditor = () => {
    const idEmpleado = $("editEmpId").value;
    const idCargo = $("editCargoId").value;

    const emp = db.empleados.find(e => e.idEmpleado === idEmpleado);
    const cargo = emp?.cargos?.find(c => c.idCargo === idCargo);
    if (!emp || !cargo) return toast("No pude guardar (registro no encontrado)");

    const cuil = normCuil($("editCuil").value);
    if (cuil.length !== 11) return toast("CUIL inv√°lido (deben ser 11 d√≠gitos)");

    // evitar duplicados de CUIL (otro empleado con mismo cuil)
    const other = db.empleados.find(e => e.idEmpleado !== emp.idEmpleado && normCuil(e.cuil) === cuil);
    if (other) return toast("Ya existe otro empleado con ese CUIL");

    const nivel = (() => {
      const n = toUpper($("editNivel").value);
      if (["FORMACION","MEDIA","SUPERIOR"].includes(n)) return n;
      return "MEDIA";
    })();

    // Guardar estado anterior para auditor√≠a
    const empAntes = {
      cuil: emp.cuil,
      apellidoNombre: emp.apellidoNombre,
      nivel: emp.nivel,
      per: emp.per,
      subl: emp.subl,
      sitRevista: emp.sitRevista,
      porcJubilacion: emp.porcJubilacion,
      obraSocial: emp.obraSocial,
      escalafonAntiguedad: emp.escalafonAntiguedad,
      fechaAltaEstab: emp.estabBySoc?.[currentSoc]?.fechaAltaEstab || ""
    };
    
    const cargoAntes = {
      seccion: cargo.seccion,
      cargo: cargo.cargo,
      categoria: cargo.categoria,
      p1: cargo.p1,
      p2: cargo.p2,
      horas: cargo.horas,
      aa: cargo.aa,
      mm: cargo.mm,
      porc: cargo.porc,
      fechaAltaCargo: cargo.fechaAltaCargo,
      fechaBajaCargo: cargo.fechaBajaCargo,
      estado: cargo.estado
    };

    // Aplicar cambios
    emp.cuil = cuil;
    emp.apellidoNombre = toUpper($("editApellidoNombre").value);
    emp.nivel = nivel;

    emp.per = $("editPer").value.trim();
    emp.subl = $("editSubl").value.trim();
    emp.sitRevista = $("editSitRevista").value.trim();
    emp.porcJubilacion = $("editPorcJub").value.trim();
    emp.obraSocial = $("editObraSocial").value.trim();
    emp.escalafonAntiguedad = $("editEscAnt").value.trim();
    ensureEmpHist(emp);
    const altaTxt = $("editFechaAltaEstab").value.trim();
    emp.estabBySoc[currentSoc].fechaAltaEstab = altaTxt ? toDDMMYYYY(altaTxt) : "";
    // legacy (compatibilidad): solo se setea si estaba vac√≠o
    if (!emp.fechaAltaEstab && emp.estabBySoc[currentSoc].fechaAltaEstab) emp.fechaAltaEstab = emp.estabBySoc[currentSoc].fechaAltaEstab;

    cargo.seccion = $("editSeccion").value.trim();
    cargo.cargo = $("editCargo").value.trim();
    cargo.categoria = $("editCategoria").value.trim();
    cargo.p1 = $("editP1").value.trim();
    cargo.p2 = $("editP2").value.trim();
    cargo.horas = $("editHoras").value.trim() === "" ? "" : toNum($("editHoras").value);
    cargo.aa = $("editAA").value.trim();
    cargo.mm = $("editMM").value.trim();
    cargo.porc = $("editPORC").value.trim();
    cargo.fechaAltaCargo = $("editFechaAltaCargo").value.trim();
    cargo.fechaBajaCargo = $("editFechaBajaCargo").value.trim();
    cargo.estado = $("editEstado").value;

    // mantener nivel tambi√©n en el cargo (para reportes por cargo)
    cargo.nivel = nivel;

    // Registrar cambios en auditor√≠a
    const empDespues = {
      cuil: emp.cuil,
      apellidoNombre: emp.apellidoNombre,
      nivel: emp.nivel,
      per: emp.per,
      subl: emp.subl,
      sitRevista: emp.sitRevista,
      porcJubilacion: emp.porcJubilacion,
      obraSocial: emp.obraSocial,
      escalafonAntiguedad: emp.escalafonAntiguedad,
      fechaAltaEstab: emp.estabBySoc?.[currentSoc]?.fechaAltaEstab || ""
    };
    
    const cargoDespues = {
      seccion: cargo.seccion,
      cargo: cargo.cargo,
      categoria: cargo.categoria,
      p1: cargo.p1,
      p2: cargo.p2,
      horas: cargo.horas,
      aa: cargo.aa,
      mm: cargo.mm,
      porc: cargo.porc,
      fechaAltaCargo: cargo.fechaAltaCargo,
      fechaBajaCargo: cargo.fechaBajaCargo,
      estado: cargo.estado
    };
    
    auditarCambios('empleado', idEmpleado, emp.cuil, emp.apellidoNombre, empAntes, empDespues);
    auditarCambios('cargo', idEmpleado, emp.cuil, emp.apellidoNombre, cargoAntes, cargoDespues, idCargo);

    save();
    renderEmpleados();
    renderDashboard();
    renderAntiguedades();
    renderNovedades();
    closeEmpEditor();
    toast("Cambios guardados");
  };
// ---------- Import (Empleados Inteligente: mapeo + upsert) ----------
  // Estado del importador
  let impRows = [];
  let impHeaders = [];
  let impMap = {
    cuil: "",
    apellidoNombre: "",
    // empleado
    nivel: "",
    per: "",
    subl: "",
    sitRevista: "",
    porcJubilacion: "",
    obraSocial: "",
    fechaAltaEstab: "",
    escalafonAntiguedad: "",
    // cargo
    seccion: "",
    cargo: "",
    p1: "",
    p2: "",
    categoria: "",
    fechaAltaCargo: "",
    fechaBajaCargo: "",
    horas: "",
    aa: "",
    mm: "",
    porc: ""
  };

  const normHeader = (h) => toUpper(String(h ?? "")).replace(/\s+/g, " ").trim();

  const guessHeader = (headers, candidates) => {
    const H = headers.map(h => ({ raw: h, norm: normHeader(h) }));
    for (const cand of candidates) {
      const target = normHeader(cand);
      const hit = H.find(x => x.norm === target) || H.find(x => x.norm.includes(target));
      if (hit) return hit.raw;
    }
    return "";
  };// ---------- Importador Novedades ----------
  let novImpRows = [];
  let novImpHeaders = [];
  let novImpMap = {
    cuil: "",
    apellidoNombre: "",
    sitRevista: "",
    puntaje: "",
    altaCargo: "",
    aa: "",
    mm: "",
    cargo: "",
    p1: "",
    p2: "",
    seccion: "",
    horasCargo: "",
    dtoObl: "",
    licencia: "",
    obs: "",
    bajaDia: "",
    bajaMes: "",
    bajaAnio: "",
    horasExtra: "",
    bonificacion: ""
  };
  let novImpRejectedRows = []; // se exportan

  const inferNovMapping = (headers) => {
    const findH = (reLike) => headers.find(h => reLike.test(String(h).toLowerCase()));
    return {
      cuil: findH(/c\.?u\.?i\.?l/) || "",
      aa: findH(/^aa$|a√±o|anio/) || "",
      mm: findH(/^mm$|mes/) || "",
      cargo: findH(/^cargo$/) || "",
      p1: findH(/^p1$/) || "",
      p2: findH(/^p2$/) || "",
      seccion: findH(/secci|nro\s*-\s*nombre\s*seccion|nombre\s*seccion/) || "",
      horasCargo: findH(/horas|hs\.?ca|hs/) || "",
      dtoObl: findH(/dto\.?\s*obl|descuento/) || "",
      licencia: findH(/licencia/) || "",
      obs: findH(/observ|obs/) || "",
      bajaDia: findH(/dia\s*baja|d[i√≠]a\s*baja/) || "",
      bajaMes: findH(/mes\s*baja/) || "",
      bajaAnio: findH(/a[n√±]o\s*baja|anio\s*baja/) || "",
      horasExtra: findH(/horas\s*extras?|extra/) || "",
      bonificacion: findH(/bonif/) || ""
    };
  };

  const renderNovImportMappingUI = () => {
    const grid = $("novImpMapGrid");
    const prev = $("novImpPreview");
    const sample = $("novImpSampleWrap");
    const report = $("novImpReport");
    const btnImport = $("btnNovImpImport");

    if (!grid || !prev || !sample || !report || !btnImport) return;

    if (!novImpRows.length) {
      prev.textContent = "Esperando archivo‚Ä¶";
      grid.innerHTML = "";
      sample.innerHTML = "";
      report.textContent = "";
      btnImport.disabled = true;
      return;
    }

    prev.textContent = `${novImpRows.length} filas detectadas. Sociedad activa: ${currentSoc}.`;
    // campos a mapear
    const fields = [
      ["cuil","CUIL (obligatorio)"],
      ["apellidoNombre","Apellido y Nombre"],
      ["sitRevista","Sit. Revista / s.rev"],
      ["puntaje","Puntaje"],
      ["altaCargo","ALTA (fecha alta cargo)"],
      ["aa","AA (a√±o)"],
      ["mm","MM (mes)"],
      ["cargo","Cargo (texto)"],
      ["p1","P1"],
      ["p2","P2"],
      ["seccion","Secci√≥n"],
      ["horasCargo","Horas Cargo"],
      ["dtoObl","DTO. OBL (descuento horas)"],
      ["licencia","LICENCIA"],
      ["obs","OBSERVACIONES"],
      ["bajaDia","D√≠a Baja"],
      ["bajaMes","Mes Baja"],
      ["bajaAnio","A√±o Baja"],
      ["horasExtra","Horas Extras"],
      ["bonificacion","Bonificaci√≥n"]
    ];

    grid.innerHTML = fields.map(([k,label]) => {
      return `
        <div>
          <div class="smallLabel">${label}</div>
          <select data-map="${k}">
            ${buildSelect(k, novImpHeaders, novImpMap[k])}
          </select>
        </div>
      `;
    }).join("");

    // sample preview
    const sampleRows = novImpRows.slice(0, 5);
    const cols = novImpHeaders.slice(0, 10);
    const head = cols.map(c => `<th>${String(c).replaceAll("<","&lt;").replaceAll(">","&gt;")}</th>`).join("");
    const body = sampleRows.map(r => `<tr>${cols.map(c => `<td>${String(r[c] ?? "").replaceAll("<","&lt;").replaceAll(">","&gt;")}</td>`).join("")}</tr>`).join("");
    sample.innerHTML = `
      <div class="hint" style="margin:8px 0 6px">Vista previa (primeras columnas)</div>
      <div class="tableWrap">
        <table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>
      </div>
    `;

    // habilitar import si hay CUIL y (AA/MM o fallback)
    const fallback = $("chkNovPeriodoFallback")?.checked;
    btnImport.disabled = !(novImpMap.cuil && ((novImpMap.aa && novImpMap.mm) || fallback));
    report.textContent = "";
  };

  const detectNovImportColumns = async () => {
    const f = $("novImpFile")?.files?.[0];
    if (!f) return toast("Eleg√≠ un archivo");
    try { novImpRows = await readRowsFromFile(f); }
    catch { novImpRows = []; novImpHeaders = []; renderNovImportMappingUI(); return toast("No pude leer el archivo"); }

    if (!novImpRows.length) { novImpHeaders = []; renderNovImportMappingUI(); return toast("Archivo vac√≠o o sin filas"); }

    const set = new Set();
    novImpRows.slice(0, 80).forEach(r => Object.keys(r || {}).forEach(k => set.add(k)));
    novImpHeaders = Array.from(set);

    novImpMap = { ...novImpMap, ...inferNovMapping(novImpHeaders) };
    // Report reset
    novImpRejectedRows = [];
    $("btnNovDownloadRejected") && ($("btnNovDownloadRejected").style.display = "none");
    renderNovImportMappingUI();
  };

  const parsePeriodoFromAAMM = (aa, mm, fallbackPeriod) => {
    const a = String(aa ?? "").trim();
    const m = String(mm ?? "").trim();
    if (a && m) {
      const yy = a.length === 2 ? ("20" + a) : a;
      const mm2 = m.padStart(2,"0");
      if (/^\d{4}$/.test(yy) && /^\d{2}$/.test(mm2) && Number(mm2) >= 1 && Number(mm2) <= 12) return `${yy}-${mm2}`;
    }
    return fallbackPeriod || "";
  };

  const importNovedadesDesdeArchivo = () => {
    const fallback = $("chkNovPeriodoFallback")?.checked;
    const fallbackPeriod = $("novPeriodo")?.value || "";
    const updMaster = $("chkNovUpdateMaster")?.checked;
    const allowCreateEmp = $("chkNovCreateMissingEmp")?.checked;
    const allowCreateCargo = $("chkNovCreateMissingCargo")?.checked;
    if (!novImpRows.length) return toast("Primero detect√° columnas");
    if (!novImpMap.cuil) return toast("Mape√° CUIL");

    const usedPeriod = fallbackPeriod || new Date().toISOString().slice(0,7);

    const periodTest = fallback ? usedPeriod : parsePeriodoFromAAMM("2026","01", "");
    // Validate closed period
    const created = [];
    novImpRejectedRows = [];
    let createdCount = 0, skippedDup = 0;

    const mkKey = (n) => `${n.sociedad}|${n.periodo}|${n.idEmpleado}|${n.idCargo||""}|${n.tipo}|${String(n.valor??"")}|${n.detalle||""}|${n.fecha||""}`;

    const existingKeys = new Set(db.novedades.map(mkKey));

    novImpRows.forEach((row, idx) => {
      const rawCuil = normCuil(getCell(row, novImpMap.cuil));
      if (rawCuil.length !== 11) {
        novImpRejectedRows.push({ fila: idx+2, motivo: "CUIL inv√°lido", ...row });
        return;
      }

      const periodo = parsePeriodoFromAAMM(getCell(row, novImpMap.aa), getCell(row, novImpMap.mm), fallback ? usedPeriod : "");
      if (!periodo) {
        novImpRejectedRows.push({ fila: idx+2, motivo: "AA/MM inv√°lido o faltante", ...row });
        return;
      }

      if (isPeriodoCerrado(currentSoc, periodo)) {
        novImpRejectedRows.push({ fila: idx+2, motivo: `Per√≠odo cerrado (${periodo})`, ...row });
        return;
      }

      let emp = db.empleados.find(e => normCuil(e.cuil) === rawCuil);
      if (!emp) {
        if (!allowCreateEmp) {
          novImpRejectedRows.push({ fila: idx+2, motivo: "Empleado no existe en el sistema (importar empleados primero)", ...row });
          return;
        }
        emp = { idEmpleado: uid(), cuil: rawCuil, apellidoNombre: String(getCell(row, novImpMap.apellidoNombre)||"").trim(), cargos: [] };
        ensureEmpHist(emp);
        // defaults
        emp.nivel = getNivelLiquidacion(currentSoc);
        db.empleados.push(emp);
      }
      // Actualizar maestro desde Excel (opcional)
      if (updMaster) {
        const apyn = String(getCell(row, novImpMap.apellidoNombre) || "").trim();
        if (apyn) emp.apellidoNombre = apyn;
        const srev = String(getCell(row, novImpMap.sitRevista) || "").trim();
        if (srev) emp.sitRevista = srev;
        const punt = String(getCell(row, novImpMap.puntaje) || "").trim();
        if (punt) emp.puntaje = punt;
      }

      // Debe tener al menos un cargo en la sociedad activa (si no, se puede crear si est√° habilitado)
      if (!(emp.cargos || []).some(c => c.sociedad === currentSoc) && !allowCreateCargo) {
        novImpRejectedRows.push({ fila: idx+2, motivo: "Empleado sin cargo en sociedad activa", ...row });
        return;
      }

      const rowInfo = {
        cargo: getCell(row, novImpMap.cargo),
        p1: getCell(row, novImpMap.p1),
        p2: getCell(row, novImpMap.p2),
        seccion: getCell(row, novImpMap.seccion),
      };
      let cargoObj = findCargoFor(emp, currentSoc, rowInfo);

      // Crear cargo si no existe (opcional)
      if (!cargoObj && allowCreateCargo) {
        const cargoTxt = String(getCell(row, novImpMap.cargo) || getCell(row, novImpMap.p1) || "").trim();
        const p1v = String(getCell(row, novImpMap.p1) || "").trim();
        const p2v = String(getCell(row, novImpMap.p2) || "").trim();
        const secv = String(getCell(row, novImpMap.seccion) || "").trim();
        const horasV = String(getCell(row, novImpMap.horasCargo) || "").trim();
        const altaV = String(getCell(row, novImpMap.altaCargo) || "").trim();

        cargoObj = {
          idCargo: uid(),
          sociedad: currentSoc,
          seccion: secv,
          cargo: cargoTxt || p1v || "",
          horas: horasV ? toNum(horasV) : "",
          estado: "Activo",
          nivel: normalizeNivel(emp.nivel) || getNivelLiquidacion(currentSoc),
          p1: p1v,
          p2: p2v,
          categoria: "",
          fechaAltaCargo: altaV ? toDDMMYYYY(altaV) : "",
          fechaBajaCargo: "",
          aa: "",
          mm: "",
          porc: ""
        };
        emp.cargos = Array.isArray(emp.cargos) ? emp.cargos : [];
        emp.cargos.push(cargoObj);
      }

      const idCargo = cargoObj?.idCargo || "";

      // Actualizar cargo desde Excel (opcional)
      if (updMaster && cargoObj) {
        const cargoTxt = String(getCell(row, novImpMap.cargo) || "").trim();
        if (cargoTxt) cargoObj.cargo = cargoTxt;
        const horasV = String(getCell(row, novImpMap.horasCargo) || "").trim();
        if (horasV) cargoObj.horas = toNum(horasV);
        const altaV = String(getCell(row, novImpMap.altaCargo) || "").trim();
        if (altaV) cargoObj.fechaAltaCargo = toDDMMYYYY(altaV);
      }

      const obs = String(getCell(row, novImpMap.obs) || "").trim();
      const origen = { file: ($("novImpFile")?.files?.[0]?.name || ""), row: idx+2 };

      const pushNov = (tipo, valor, detalle, fecha) => {
        const nov = {
          idNovedad: uid(),
          sociedad: currentSoc,
          periodo,
          idEmpleado: emp.idEmpleado,
          idCargo,
          tipo,
          valor: (valor ?? 0),
          detalle: (detalle || "").trim(),
          fecha: fecha || "",
          estado: "cargada",
          origen
        };
        const k = mkKey(nov);
        if (existingKeys.has(k)) { skippedDup++; return; }
        existingKeys.add(k);
        db.novedades.push(nov);
        createdCount++;
        created.push(nov);
      };

      // Normalizaciones principales
      const dto = toNum(getCell(row, novImpMap.dtoObl));
      if (dto > 0) pushNov("Descuento Horas (DTO. OBL)", dto, obs, "");

      const lic = String(getCell(row, novImpMap.licencia) || "").trim();
      if (lic) pushNov("Licencia", 0, (lic + (obs ? " | " + obs : "")), "");

      const diaCell = getCell(row, novImpMap.bajaDia);
      const mesCell = getCell(row, novImpMap.bajaMes);
      const anioCell = getCell(row, novImpMap.bajaAnio);

      const dia = String(diaCell || "").trim();
      const mes = String(mesCell || "").trim();
      const anio = String(anioCell || "").trim();

      // Caso 1: d√≠a/mes/a√±o separados
      if (dia && mes && anio) {
        const dd = String(dia).padStart(2,"0");
        const mm = String(mes).padStart(2,"0");
        const yyyy = String(anio).length===2 ? ("20"+anio) : String(anio);
        const fecha = (/^\d{4}$/.test(yyyy) && /^\d{2}$/.test(mm) && /^\d{2}$/.test(dd)) ? `${yyyy}-${mm}-${dd}` : "";
        if (fecha) pushNov("Baja Cargo", 0, obs, fecha);
      } else {
        // Caso 2: "Dia Baja" viene como fecha completa (Date/serial)
        const d = parseDateFlexible(diaCell);
        if (d) {
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,"0");
          const dd = String(d.getDate()).padStart(2,"0");
          pushNov("Baja Cargo", 0, obs, `${yyyy}-${mm}-${dd}`);
        }
      }

      const he = toNum(getCell(row, novImpMap.horasExtra));
      if (he > 0) pushNov("Horas Extras", he, obs, "");

      const bon = toNum(getCell(row, novImpMap.bonificacion));
      if (bon > 0) pushNov("Bonificaci√≥n", bon, obs, "");
    });

    save();
    renderNovedades();

    const report = $("novImpReport");
    if (report) report.textContent = `Importaci√≥n completa. Creadas: ${createdCount}. Duplicadas omitidas: ${skippedDup}. Rechazadas: ${novImpRejectedRows.length}.`;

    const btnDl = $("btnNovDownloadRejected");
    if (btnDl) btnDl.style.display = novImpRejectedRows.length ? "inline-flex" : "none";
    toast(`Novedades importadas: ${createdCount} (rechazadas: ${novImpRejectedRows.length})`);
  };


  // ---------- Control de liquidaci√≥n (Importable: comparar contra maestro) ----------
  let liqCtrlRows = [];
  let liqCtrlHeaders = [];
  let liqCtrlMap = {
    cuil: "",
    apellidoNombre: "",
    nivel: "",
    escalafonAntiguedad: "",
    antigDias: "",
    fechaAltaEstab: "",
    seccion: "",
    cargo: "",
    p1: "",
    p2: "",
    fechaAltaCargo: "",
    horas: ""
  };
  let liqCtrlDiffRows = [];

  const inferLiqCtrlMapping = (headers) => {
    const findH = (reLike) => headers.find(h => reLike.test(String(h).toLowerCase()));
    return {
      cuil: findH(/c\.?u\.?i\.?l/) || "",
      apellidoNombre: findH(/apellido.*nombre|apell.*nombre|nombre\s*y\s*apellido/) || "",
      nivel: findH(/^nivel$|\bnivel\b/) || "",
      escalafonAntiguedad: findH(/escalad|escalaf|antiguedad(?!.*dia)/) || "",
      antigDias: findH(/antig.*d[i√≠]a|dias\s*antig/) || "",
      fechaAltaEstab: findH(/alta.*establ|alta.*establec|fecha.*alta.*estab/) || "",
      seccion: findH(/secci|nro\s*-\s*nombre\s*seccion|nombre\s*seccion/) || "",
      cargo: findH(/^cargo$/) || "",
      p1: findH(/^p1$/) || "",
      p2: findH(/^p2$/) || "",
      fechaAltaCargo: findH(/alta.*cargo|fecha.*alta.*cargo/) || "",
      horas: findH(/\bhoras\b|\bhs\b/) || ""
    };
  };

  const renderLiqCtrlUI = () => {
    const grid = $("liqCtrlMapGrid");
    const prev = $("liqCtrlPreview");
    const report = $("liqCtrlReport");
    const wrap = $("liqCtrlDiffWrap");
    const btnAnalyze = $("btnLiqCtrlAnalyze");
    const btnDl = $("btnLiqCtrlDownloadDiff");

    if (!grid || !prev || !report || !wrap || !btnAnalyze || !btnDl) return;

    if (!liqCtrlRows.length) {
      prev.textContent = "Esperando archivo‚Ä¶";
      grid.innerHTML = "";
      report.textContent = "";
      wrap.innerHTML = "";
      btnAnalyze.disabled = true;
      btnDl.disabled = true;
      return;
    }

    prev.textContent = `${liqCtrlRows.length} filas detectadas. Sociedad activa: ${currentSoc}.`;
    const fields = [
      ["cuil","CUIL (obligatorio)"],
      ["apellidoNombre","Apellido y Nombre"],
      ["nivel","Nivel (Formaci√≥n/Media/Superior)"],
      ["escalafonAntiguedad","Escalada de Antig√ºedad (texto)"],
      ["antigDias","Antig√ºedad (d√≠as)"],
      ["fechaAltaEstab","Fecha alta establecimiento"],
      ["seccion","Secci√≥n"],
      ["cargo","Cargo (texto)"],
      ["p1","P1"],
      ["p2","P2"],
      ["fechaAltaCargo","Fecha alta cargo"],
      ["horas","Horas"]
    ];

    
    const buildOptions = (headers, value) => {
      const safe = (x) => String(x).replaceAll('"','&quot;');
      return ['<option value="">(Sin asignar)</option>']
        .concat(headers.map(h => `<option value="${safe(h)}" ${h===value?'selected':''}>${h}</option>`))
        .join("");
    };

    grid.innerHTML = fields.map(([k,label]) => {
      return `
        <div>
          <div class="smallLabel">${label}</div>
          <select data-map="${k}">
            ${buildOptions(liqCtrlHeaders, liqCtrlMap[k])}
          </select>
        </div>
      `;
    }).join("");


    btnAnalyze.disabled = !liqCtrlMap.cuil;
    btnDl.disabled = !liqCtrlDiffRows.length;

    report.textContent = "";
  };

  const detectLiqCtrlColumns = async () => {
    const f = $("liqCtrlFile")?.files?.[0];
    if (!f) return toast("Eleg√≠ un archivo");
    try { liqCtrlRows = await readRowsFromFile(f); }
    catch { liqCtrlRows = []; liqCtrlHeaders = []; renderLiqCtrlUI(); return toast("No pude leer el archivo"); }

    if (!liqCtrlRows.length) { liqCtrlHeaders = []; renderLiqCtrlUI(); return toast("Archivo vac√≠o o sin filas"); }

    const set = new Set();
    liqCtrlRows.slice(0, 120).forEach(r => Object.keys(r || {}).forEach(k => set.add(k)));
    liqCtrlHeaders = Array.from(set);

    liqCtrlMap = { ...liqCtrlMap, ...inferLiqCtrlMapping(liqCtrlHeaders) };
    liqCtrlDiffRows = [];
    renderLiqCtrlUI();
  };

  const analyzeLiqCtrlDiff = () => {
    if (!liqCtrlRows.length) return toast("Primero detect√° columnas");
    if (!liqCtrlMap.cuil) return toast("Mape√° CUIL");

    liqCtrlDiffRows = [];
    const diffs = [];

    const normTxt = (v) => String(v ?? "").trim();
    const normDate = (v) => toDDMMYYYY(v || "");
    const eq = (a,b) => normTxt(a).toLowerCase() === normTxt(b).toLowerCase();

    const pushDiff = (emp, cargo, campo, sysVal, fileVal) => {
      diffs.push({
        sociedad: currentSoc,
        periodo: $("novPeriodo")?.value || "",
        cuil: formatCuil(emp?.cuil || ""),
        empleado: emp?.apellidoNombre || "",
        idEmpleado: emp?.idEmpleado || "",
        idCargo: cargo?.idCargo || "",
        campo,
        sistema: String(sysVal ?? ""),
        archivo: String(fileVal ?? "")
      });
    };

    liqCtrlRows.forEach((row, idx) => {
      const cuilRaw = normCuil(getCell(row, liqCtrlMap.cuil));
      if (cuilRaw.length !== 11) return;

      const emp = db.empleados.find(e => normCuil(e.cuil) === cuilRaw);
      if (!emp) {
        diffs.push({
          sociedad: currentSoc,
          periodo: $("novPeriodo")?.value || "",
          cuil: formatCuil(cuilRaw),
          empleado: "",
          idEmpleado: "",
          idCargo: "",
          campo: "Empleado inexistente en maestro",
          sistema: "",
          archivo: "Fila en planilla"
        });
        return;
      }

      // Match de cargo (si hay info en planilla)
      const rowInfo = {
        cargo: getCell(row, liqCtrlMap.cargo),
        p1: getCell(row, liqCtrlMap.p1),
        p2: getCell(row, liqCtrlMap.p2),
        seccion: getCell(row, liqCtrlMap.seccion)
      };
      let cargo = findCargoFor(emp, currentSoc, rowInfo);
      if (!cargo) cargo = (emp.cargos || []).find(c => c.sociedad === currentSoc) || null;

      // Comparaciones (solo si la columna fue mapeada y el archivo trae algo)
      const fApyn = normTxt(getCell(row, liqCtrlMap.apellidoNombre));
      if (liqCtrlMap.apellidoNombre && fApyn && !eq(emp.apellidoNombre, fApyn)) pushDiff(emp, cargo, "Apellido y Nombre", emp.apellidoNombre, fApyn);

      const fNivel = normalizeNivel(normTxt(getCell(row, liqCtrlMap.nivel)));
      if (liqCtrlMap.nivel && fNivel && !eq(normalizeNivel(emp.nivel), fNivel)) pushDiff(emp, cargo, "Nivel", emp.nivel, fNivel);

      const fEsc = normTxt(getCell(row, liqCtrlMap.escalafonAntiguedad));
      if (liqCtrlMap.escalafonAntiguedad && fEsc && !eq(emp.escalafonAntiguedad, fEsc)) pushDiff(emp, cargo, "Escalada de Antig√ºedad", emp.escalafonAntiguedad, fEsc);

      const fDias = toNum(getCell(row, liqCtrlMap.antigDias));
      if (liqCtrlMap.antigDias && fDias) {
        const sysDias = antiguedadDias(emp, currentSoc);
        if (Math.round(sysDias) !== Math.round(fDias)) pushDiff(emp, cargo, "Antig√ºedad (d√≠as)", sysDias, fDias);
      }

      const fAltaEst = normDate(getCell(row, liqCtrlMap.fechaAltaEstab));
      const sysAltaEst = (emp.estabBySoc?.[currentSoc]?.fechaAltaEstab || "");
      if (liqCtrlMap.fechaAltaEstab && fAltaEst && !eq(sysAltaEst, fAltaEst)) pushDiff(emp, cargo, "Fecha alta establecimiento", sysAltaEst, fAltaEst);

      if (cargo) {
        const fHoras = toNum(getCell(row, liqCtrlMap.horas));
        if (liqCtrlMap.horas && fHoras) {
          const sysHoras = toNum(cargo.horas);
          if (Math.round(sysHoras*100)/100 !== Math.round(fHoras*100)/100) pushDiff(emp, cargo, "Horas (cargo)", cargo.horas, fHoras);
        }
        const fAltaCargo = normDate(getCell(row, liqCtrlMap.fechaAltaCargo));
        if (liqCtrlMap.fechaAltaCargo && fAltaCargo && !eq(cargo.fechaAltaCargo, fAltaCargo)) pushDiff(emp, cargo, "Fecha alta cargo", cargo.fechaAltaCargo, fAltaCargo);

        const fP1 = normTxt(getCell(row, liqCtrlMap.p1));
        if (liqCtrlMap.p1 && fP1 && !eq(cargo.p1, fP1)) pushDiff(emp, cargo, "P1", cargo.p1, fP1);

        const fP2 = normTxt(getCell(row, liqCtrlMap.p2));
        if (liqCtrlMap.p2 && fP2 && !eq(cargo.p2, fP2)) pushDiff(emp, cargo, "P2", cargo.p2, fP2);

        const fSec = normTxt(getCell(row, liqCtrlMap.seccion));
        if (liqCtrlMap.seccion && fSec && !eq(cargo.seccion, fSec)) pushDiff(emp, cargo, "Secci√≥n", cargo.seccion, fSec);
      }
    });

    liqCtrlDiffRows = diffs;

    const report = $("liqCtrlReport");
    if (report) {
      const total = liqCtrlRows.length;
      report.textContent = `An√°lisis listo. Filas: ${total}. Diferencias detectadas: ${diffs.length}.`;
    }

    const wrap = $("liqCtrlDiffWrap");
    if (wrap) {
      if (!diffs.length) {
        wrap.innerHTML = `<div class="hint">Sin diferencias relevantes detectadas con el mapeo actual.</div>`;
      } else {
        const top = diffs.slice(0, 25).map(d => `
          <tr>
            <td>${escapeHtml(d.cuil||"")}</td>
            <td>${escapeHtml(d.empleado||"")}</td>
            <td>${escapeHtml(d.campo||"")}</td>
            <td>${escapeHtml(d.sistema||"")}</td>
            <td>${escapeHtml(d.archivo||"")}</td>
          </tr>
        `).join("");
        wrap.innerHTML = `
          <div class="hint" style="margin-bottom:8px">Vista previa (hasta 25 diferencias)</div>
          <div class="tableWrap">
            <table>
              <thead><tr><th>CUIL</th><th>Empleado</th><th>Campo</th><th>Sistema</th><th>Archivo</th></tr></thead>
              <tbody>${top}</tbody>
            </table>
          </div>
        `;
      }
    }

    $("btnLiqCtrlDownloadDiff") && ($("btnLiqCtrlDownloadDiff").disabled = !diffs.length);
    toast(diffs.length ? `Diferencias: ${diffs.length}` : "Sin diferencias");
  };
  const inferMapping = (headers) => ({
    // claves principales
    cuil: guessHeader(headers, ["CUIL", "CUIL/CUIT", "CUIT", "NRO CUIL", "CUIL CUIT", "NROCUIL", "C.U.I.L."]),
    apellidoNombre: guessHeader(headers, ["APELLIDO Y NOMBRE", "APELLIDO NOMBRE", "APELLIDO, NOMBRE", "Apellido y Nombre"]),
    // empleado (seg√∫n tus planillas)
    per: guessHeader(headers, ["PER", "Per"]),
    subl: guessHeader(headers, ["SUBL", "Subl"]),
    sitRevista: guessHeader(headers, ["SIT. REVISTA", "SIT REVISTA", "Sit. Revista", "SITUACION DE REVISTA"]),
    porcJubilacion: guessHeader(headers, ["% JUB", "% JUBILACION", "% JUBILACI√ìN", "% jubilacion"]),
    obraSocial: guessHeader(headers, ["OBRA SOCIAL (CODIGO) + NOMBRE", "OBRA SOCIAL", "O. SOCIAL (CODIGO) + NOMBRE"]),
    fechaAltaEstab: guessHeader(headers, ["FECHA DE ALTA AL ESTABL.", "FECHA DE ALTA AL ESTABLECIMIENTO", "ALTA AL ESTABL.", "Alta al establ."]),
    escalafonAntiguedad: guessHeader(headers, ["ESCALADA DE ANTIGUEDAD", "ESCALAFON ANTIGUEDAD", "ANTIGUEDAD", "Escalada de Antiguedad"]),
    nivel: guessHeader(headers, ["NIVEL", "Nivel"]),
    // cargo
    seccion: guessHeader(headers, ["NRO - NOMBRE SECCION", "NRO - NOMBRE SECCI√ìN", "NRO NOMBRE SECCION", "SECCI√ìN", "SECCION", "nro - nombre seccion"]),
    cargo: guessHeader(headers, ["CARGO", "Cargo"]),
    p1: guessHeader(headers, ["P1"]),
    p2: guessHeader(headers, ["P2"]),
    categoria: guessHeader(headers, ["CATEGORIA", "CATEGOR√çA", "Categor√≠a"]),
    fechaAltaCargo: guessHeader(headers, ["FECHA DE ALTA AL CARGO", "FECHA ALTA AL CARGO", "ALTA AL CARGO", "Fecha de alta al cargo"]),
    fechaBajaCargo: guessHeader(headers, ["FECHA DE BAJA AL CARGO", "FECHA BAJA AL CARGO", "BAJA AL CARGO", "Fecha de Baja al cargo"]),
    horas: guessHeader(headers, ["HORAS", "Horas"]),
    aa: guessHeader(headers, ["AA"]),
    mm: guessHeader(headers, ["MM"]),
    porc: guessHeader(headers, ["PORC", "PORC."])
  });

  const fieldLabels = {
    cuil: "CUIL",
    apellidoNombre: "Apellido y Nombre",
    nivel: "Nivel (Formaci√≥n/Media/Superior)",
    per: "Per",
    subl: "Subl",
    sitRevista: "Sit. Revista",
    porcJubilacion: "% jubilaci√≥n",
    obraSocial: "Obra SOCIAL (CODIGO) + NOMBRE",
    fechaAltaEstab: "Fecha de alta al establecimiento",
    escalafonAntiguedad: "Escalada de Antig√ºedad",
    seccion: "nro - nombre secci√≥n",
    cargo: "Cargo",
    p1: "P1",
    p2: "P2",
    categoria: "Categor√≠a",
    fechaAltaCargo: "Fecha de alta al cargo",
    fechaBajaCargo: "Fecha de baja al cargo",
    horas: "Horas",
    aa: "AA",
    mm: "MM",
    porc: "PORC"
  };

  const buildSelect = (id, headers, value) => {
    const opts = ['<option value="">(Sin asignar)</option>']
      .concat(headers.map(h => `<option value="${String(h).replaceAll('"','&quot;')}" ${h===value?'selected':''}>${h}</option>`))
      .join("");
    return `<label style="min-width:220px">${fieldLabels[id] || id}<select data-map="${id}">${opts}</select></label>`;
  };

  const renderImportMappingUI = () => {
    const wrap = $("impMapWrap");
    const grid = $("impMapGrid");
    const preview = $("impPreview");
    const btnImport = $("btnImport");

    if (!wrap || !grid || !preview || !btnImport) return;

    if (!impHeaders.length) {
      wrap.style.display = "none";
      btnImport.disabled = true;
      preview.textContent = "Esperando archivo‚Ä¶";
      return;
    }

    // Build mapping selects
    grid.innerHTML = [
      // obligatorios / base
      buildSelect("cuil", impHeaders, impMap.cuil),
      buildSelect("apellidoNombre", impHeaders, impMap.apellidoNombre),

      // empleado
      buildSelect("nivel", impHeaders, impMap.nivel),
      buildSelect("per", impHeaders, impMap.per),
      buildSelect("subl", impHeaders, impMap.subl),
      buildSelect("sitRevista", impHeaders, impMap.sitRevista),
      buildSelect("porcJubilacion", impHeaders, impMap.porcJubilacion),
      buildSelect("obraSocial", impHeaders, impMap.obraSocial),
      buildSelect("fechaAltaEstab", impHeaders, impMap.fechaAltaEstab),
      buildSelect("escalafonAntiguedad", impHeaders, impMap.escalafonAntiguedad),

      // cargo
      buildSelect("seccion", impHeaders, impMap.seccion),
      buildSelect("cargo", impHeaders, impMap.cargo),
      buildSelect("p1", impHeaders, impMap.p1),
      buildSelect("p2", impHeaders, impMap.p2),
      buildSelect("categoria", impHeaders, impMap.categoria),
      buildSelect("fechaAltaCargo", impHeaders, impMap.fechaAltaCargo),
      buildSelect("fechaBajaCargo", impHeaders, impMap.fechaBajaCargo),
      buildSelect("horas", impHeaders, impMap.horas),
      buildSelect("aa", impHeaders, impMap.aa),
      buildSelect("mm", impHeaders, impMap.mm),
      buildSelect("porc", impHeaders, impMap.porc),
    ].join("");

    wrap.style.display = "block";
    const hasCuil = Boolean(impMap.cuil);
    btnImport.disabled = !hasCuil;

    preview.textContent = `${impRows.length} filas detectadas. Sociedad activa: ${currentSoc}. ` + (hasCuil ? "Listo para importar." : "Asign√° CUIL para continuar.");

    // Vista previa (primeras filas con el mapeo aplicado)
    const sampleEl = $("impSample");
    if (sampleEl) {
      if (!hasCuil) { sampleEl.innerHTML = ""; }
      else {
        const take = impRows.slice(0, 8);
        const esc = (s) => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
        const pick = (row, key) => esc(getCell(row, impMap[key]));
        const rowsHtml = take.map(row => {
          const c = normCuil(getCell(row, impMap.cuil));
          return `<tr>
            <td style="padding:6px 8px; border-bottom:1px solid rgba(0,0,0,.06)">${esc(formatCuil(c) || getCell(row, impMap.cuil))}</td>
            <td style="padding:6px 8px; border-bottom:1px solid rgba(0,0,0,.06)">${pick(row,"apellidoNombre")}</td>
            <td style="padding:6px 8px; border-bottom:1px solid rgba(0,0,0,.06)">${pick(row,"seccion")}</td>
            <td style="padding:6px 8px; border-bottom:1px solid rgba(0,0,0,.06)">${pick(row,"cargo") || pick(row,"p1")}</td>
            <td style="padding:6px 8px; border-bottom:1px solid rgba(0,0,0,.06)">${pick(row,"horas") || pick(row,"p2")}</td>
          </tr>`;
        }).join("");
        sampleEl.innerHTML = `
          <div style="font-size:12px; margin-bottom:6px; opacity:.85">Vista previa (hasta 8 filas): lo que se va a leer del archivo seg√∫n el mapeo.</div>
          <table style="width:100%; border-collapse:collapse; font-size:12px; background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:10px; overflow:hidden">
            <thead>
              <tr style="background:rgba(12,75,63,.06)">
                <th style="text-align:left; padding:7px 8px; border-bottom:1px solid rgba(0,0,0,.06)">CUIL</th>
                <th style="text-align:left; padding:7px 8px; border-bottom:1px solid rgba(0,0,0,.06)">Apellido y Nombre</th>
                <th style="text-align:left; padding:7px 8px; border-bottom:1px solid rgba(0,0,0,.06)">Secci√≥n</th>
                <th style="text-align:left; padding:7px 8px; border-bottom:1px solid rgba(0,0,0,.06)">Cargo/P1</th>
                <th style="text-align:left; padding:7px 8px; border-bottom:1px solid rgba(0,0,0,.06)">Horas/P2</th>
              </tr>
            </thead>
            <tbody>${rowsHtml || ""}</tbody>
          </table>
        `;
      }
    }
  };

  const readRowsFromFile = async (file) => {
    const name = (file.name || "").toLowerCase();

    // CSV robusto (comillas y comas dentro de campos)
    const parseCSV = async () => {
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim().length);
      if (!lines.length) return [];

      const splitLine = (line) => {
        const out = [];
        let cur = "", inQ = false;
        for (let i=0; i<line.length; i++){
          const ch = line[i];
          if (ch === '"') {
            if (inQ && line[i+1] === '"') { cur += '"'; i++; }
            else inQ = !inQ;
          } else if (ch === "," && !inQ) { out.push(cur); cur=""; }
          else cur += ch;
        }
        out.push(cur);
        return out;
      };

      const headers = splitLine(lines[0]).map(h => h.trim()).filter(Boolean);
      return lines.slice(1).map(l => {
        const cols = splitLine(l);
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
        return obj;
      });
    };

    if (name.endsWith(".csv")) return await parseCSV();

    // Excel via XLSX
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(new Uint8Array(buf), { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(sheet, { defval: "" });
  };

  const detectImportColumns = async () => {
    const f = $("impFile")?.files?.[0];
    if (!f) return toast("Eleg√≠ un archivo");

    try { impRows = await readRowsFromFile(f); }
    catch { impRows = []; impHeaders = []; renderImportMappingUI(); return toast("No pude leer el archivo"); }

    if (!impRows.length) { impHeaders = []; renderImportMappingUI(); return toast("Archivo vac√≠o o sin filas"); }

    // Headers: union de keys (por si vienen filas con variantes)
    const set = new Set();
    impRows.slice(0, 50).forEach(r => Object.keys(r || {}).forEach(k => set.add(k)));
    impHeaders = Array.from(set);

    // Auto-mapeo
    impMap = { ...impMap, ...inferMapping(impHeaders) };
    renderImportMappingUI();
  };

  const getCell = (row, header) => (header ? row?.[header] : "");

  const importEmpleadosInteligente = () => {
    if (!impRows.length) return toast("Primero detect√° columnas");
    if (!impMap.cuil) return toast("Mape√° la columna CUIL");

    const skipEmptyCargo = $("impSkipEmptyCargo")?.checked ?? true;

    let created = 0, updated = 0, cargosAdded = 0, cargosSkipped = 0, bad = 0, noCargo = 0;

    impRows.forEach(r => {
      const cuil = normCuil(getCell(r, impMap.cuil));
      if (cuil.length !== 11) { bad++; return; }

      const nombre = toUpper(getCell(r, impMap.apellidoNombre));

      // empleado (global)
      const per = String(getCell(r, impMap.per) ?? "").trim();
      const subl = String(getCell(r, impMap.subl) ?? "").trim();
      const sitRevista = String(getCell(r, impMap.sitRevista) ?? "").trim();
      const porcJubilacion = String(getCell(r, impMap.porcJubilacion) ?? "").trim();
      const obraSocial = String(getCell(r, impMap.obraSocial) ?? "").trim();
      const fechaAltaEstab = String(getCell(r, impMap.fechaAltaEstab) ?? "").trim();
      const escalafonAntiguedad = String(getCell(r, impMap.escalafonAntiguedad) ?? "").trim();

      const nivelRaw = String(getCell(r, impMap.nivel) ?? "").trim();
      const nivel = (() => {
        const n = toUpper(nivelRaw);
        if (n.includes("FORM")) return "FORMACION";
        if (n.includes("SUP")) return "SUPERIOR";
        if (n.includes("MEDIA")) return "MEDIA";
        return n ? n : getNivelLiquidacion(currentSoc);
      })();

      // cargo (sociedad activa)
      const seccion = String(getCell(r, impMap.seccion) ?? "").trim();
      const cargoTxt = String(getCell(r, impMap.cargo) ?? "").trim();
      const horasTxt = String(getCell(r, impMap.horas) ?? "").trim();
      const horas = horasTxt === "" ? "" : toNum(horasTxt);
      const p1 = String(getCell(r, impMap.p1) ?? "").trim();
      const p2 = String(getCell(r, impMap.p2) ?? "").trim();
      const categoria = String(getCell(r, impMap.categoria) ?? "").trim();
      const fechaAltaCargo = String(getCell(r, impMap.fechaAltaCargo) ?? "").trim();
      const fechaBajaCargo = String(getCell(r, impMap.fechaBajaCargo) ?? "").trim();
      const aa = String(getCell(r, impMap.aa) ?? "").trim();
      const mm = String(getCell(r, impMap.mm) ?? "").trim();
      const porc = String(getCell(r, impMap.porc) ?? "").trim();

      // Upsert empleado (global por CUIL)
      let emp = db.empleados.find(x => normCuil(x.cuil) === cuil);
      if (!emp) {
        emp = {
          idEmpleado: uid(),
          cuil,
          apellidoNombre: nombre || "",
          // campos editables (se completan si vienen)
          nivel: nivel || getNivelLiquidacion(currentSoc),
          per: per || "",
          subl: subl || "",
          sitRevista: sitRevista || "",
          porcJubilacion: porcJubilacion || "",
          obraSocial: obraSocial || "",
          fechaAltaEstab: fechaAltaEstab || "",
          escalafonAntiguedad: escalafonAntiguedad || "",
          cargos: []
        };
        db.empleados.push(emp);
        created++;
      } else {
        if (nombre) emp.apellidoNombre = nombre;
        emp.cuil = cuil;

        // solo pisar si el import trae datos (para no borrar)
        if (nivelRaw) emp.nivel = nivel;
        if (per) emp.per = per;
        if (subl) emp.subl = subl;
        if (sitRevista) emp.sitRevista = sitRevista;
        if (porcJubilacion) emp.porcJubilacion = porcJubilacion;
        if (obraSocial) emp.obraSocial = obraSocial;
        if (fechaAltaEstab) emp.fechaAltaEstab = fechaAltaEstab;
        if (escalafonAntiguedad) emp.escalafonAntiguedad = escalafonAntiguedad;

        updated++;
      }

      ensureEmpHist(emp);
      if (fechaAltaEstab) emp.estabBySoc[currentSoc].fechaAltaEstab = toDDMMYYYY(fechaAltaEstab);



      // Cargo: opcional (seg√∫n planilla)
      const hasAnyCargoData = Boolean(seccion || cargoTxt || horasTxt || p1 || p2 || categoria || fechaAltaCargo || fechaBajaCargo || aa || mm || porc);
      const enoughForCargo = Boolean(seccion && (cargoTxt || p1)); // horas puede venir vac√≠o (ej: directivos)

      if (skipEmptyCargo && (!hasAnyCargoData || !enoughForCargo)) { noCargo++; return; }

      const cargoObj = {
        idCargo: uid(),
        sociedad: currentSoc,
        seccion,
        cargo: cargoTxt || p1 || "",
        horas: (horasTxt === "" ? "" : (horas || toNum(p2))),
        estado: "Activo",
        nivel: nivel || getNivelLiquidacion(currentSoc),
        p1,
        p2,
        categoria,
        fechaAltaCargo,
        fechaBajaCargo,
        aa,
        mm,
        porc
      };

      const added = addCargoIfNotExists(emp, cargoObj);
      if (added) cargosAdded++;
      else cargosSkipped++;
    });

    save();
    
    // Registrar importaci√≥n en auditor√≠a
    logAudit('importacion', {
      detalle: `Importaci√≥n masiva: +${created} nuevos, ~${updated} actualizados, ${cargosAdded} cargos agregados`,
      accion: 'importacion'
    });
    
    renderEmpleados();
    renderDashboard();
    renderAntiguedades();
    renderNovedades();
    toast(`Import ok. Emp: +${created} / ~${updated}. Cargos: +${cargosAdded}, dup ${cargosSkipped}. Sin cargo: ${noCargo}. Err: ${bad}`);
  };

  // ---------- Wiring ----------

  // Import panel toggle (Empleados)
  const btnShowImport = $("btnShowImport");
  if (btnShowImport) {
    btnShowImport.onclick = () => {
      const box = $("importadorEmpleados");
      if (!box) return;
      const isHidden = box.style.display === "none" || getComputedStyle(box).display === "none";
      box.style.display = isHidden ? "block" : "none";
      if (isHidden) box.scrollIntoView({ behavior: "smooth", block: "start" });
    };
  }
  const showTab = (tab) => {
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    document.querySelectorAll('section.section[id^="sec-"]').forEach(x => x.classList.add("hidden"));
    document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add("active");
    $(`sec-${tab}`)?.classList.remove("hidden");

    if (tab === "dashboard") renderDashboard();
    if (tab === "empleados") renderEmpleados();
    if (tab === "antiguedades") renderAntiguedades();
    if (tab === "novedades") renderNovedades();
    if (tab === "auditoria") { renderAuditoria(); renderSnapshots(); }
  };

  // Tab clicks
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => showTab(t.dataset.tab));
  });

  // Society toggle
  document.querySelectorAll(".societyToggle button").forEach(b => {
    b.addEventListener("click", () => {
      currentSoc = b.dataset.soc;
      document.querySelectorAll(".societyToggle button").forEach(x => x.classList.remove("active"));
      b.classList.add("active");
      renderDashboard();
      renderEmpleados();
      renderAntiguedades();
      renderNovedades();
    });
  });

  // Delegated table actions
  document.addEventListener("click", (ev) => {
    const btn = ev.target?.closest?.("button");
    if (!btn) return;
    const act = btn.dataset.act;
    if (act === "editEmp") return openEmpEditor(btn.dataset.emp, btn.dataset.cargo);
    if (act === "delCargo") return deleteCargo(btn.dataset.emp, btn.dataset.cargo);
    if (act === "delNov") return deleteNov(btn.dataset.nov);
    if (act === "toggleNovEstado") {
      const id = btn.dataset.nov;
      const n = db.novedades.find(x => x.idNovedad === id);
      if (!n) return;
      n.estado = (n.estado === "aplicada") ? "cargada" : "aplicada";
      save();
      renderNovedades();
      return;
    }
    // Acciones de Antig√ºedades
    if (act === "editAntEmp") {
      const emp = db.empleados.find(e => e.idEmpleado === btn.dataset.emp);
      if (!emp) return toast("Empleado no encontrado");
      const cargo = (emp.cargos || []).find(c => c.sociedad === currentSoc);
      if (!cargo) return toast("No tiene cargo en esta sociedad");
      return openEmpEditor(emp.idEmpleado, cargo.idCargo);
    }
    if (act === "verHistorial") {
      const emp = db.empleados.find(e => e.idEmpleado === btn.dataset.emp);
      if (!emp) return toast("Empleado no encontrado");
      const cargo = (emp.cargos || []).find(c => c.sociedad === currentSoc);
      if (!cargo) return toast("No tiene cargo en esta sociedad");
      openEmpEditor(emp.idEmpleado, cargo.idCargo);
      // Scroll al historial despu√©s de abrir
      setTimeout(() => {
        $("empHistList")?.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 100);
      return;
    }
    // Acciones de Snapshots
    if (act === "compararSnapshot") {
      return compararConSnapshot(btn.dataset.snap);
    }
    if (act === "eliminarSnapshot") {
      return eliminarSnapshot(btn.dataset.snap);
    }
  });

  $("btnReset")?.addEventListener("click", () => {
    if (confirm("¬øBorrar todo?")) {
      localStorage.removeItem(LS_KEY);
      location.reload();
    }
  });

  $("searchEmp")?.addEventListener("input", renderEmpleados);
  $("btnExport")?.addEventListener("click", exportEmpleadosCSV);
  $("btnImpDetect")?.addEventListener("click", detectImportColumns);
  $("impFile")?.addEventListener("change", () => { $("btnImport").disabled = true; detectImportColumns(); });
  $("btnImport")?.addEventListener("click", importEmpleadosInteligente);

  // ---------- Antig√ºedades: Event Listeners ----------
  $("searchAnt")?.addEventListener("input", renderAntiguedades);
  $("antSoloAlertas")?.addEventListener("change", renderAntiguedades);
  $("btnExportAntiguedades")?.addEventListener("click", exportAntiguedadesXlsx);
  $("btnCompararAntiguedades")?.addEventListener("click", () => toggleComparador(true));
  $("btnAntCompClose")?.addEventListener("click", () => toggleComparador(false));
  $("btnAntCompDetect")?.addEventListener("click", detectAntCompColumns);
  $("antCompFile")?.addEventListener("change", () => { $("btnAntCompAnalyze").disabled = true; });
  $("btnAntCompAnalyze")?.addEventListener("click", analyzeAntComp);

  // ---------- Auditor√≠a: Event Listeners ----------
  $("searchAud")?.addEventListener("input", () => { audPagina = 1; renderAuditoria(); });
  $("audFechaDesde")?.addEventListener("change", () => { audPagina = 1; renderAuditoria(); });
  $("audFechaHasta")?.addEventListener("change", () => { audPagina = 1; renderAuditoria(); });
  $("audTipoCambio")?.addEventListener("change", () => { audPagina = 1; renderAuditoria(); });
  $("btnAudFiltrar")?.addEventListener("click", () => { audPagina = 1; renderAuditoria(); });
  $("btnAudLimpiarFiltros")?.addEventListener("click", () => {
    $("searchAud").value = "";
    $("audFechaDesde").value = "";
    $("audFechaHasta").value = "";
    $("audTipoCambio").value = "";
    audPagina = 1;
    renderAuditoria();
  });
  $("btnExportAuditoria")?.addEventListener("click", exportAuditoria);
  $("btnAudPrev")?.addEventListener("click", () => { if (audPagina > 1) { audPagina--; renderAuditoria(); } });
  $("btnAudNext")?.addEventListener("click", () => { audPagina++; renderAuditoria(); });
  
  // Snapshots
  $("btnCrearSnapshot")?.addEventListener("click", crearSnapshot);
  
  // Comparador mes a mes
  $("btnCompararPeriodos")?.addEventListener("click", compararPeriodos);
  $("btnExportComparacion")?.addEventListener("click", exportComparacion);

  $("btnEmpModalClose")?.addEventListener("click", closeEmpEditor);
  $("btnEmpSave")?.addEventListener("click", saveEmpEditor);

  // Historial de per√≠odos (empleado)
  $("btnHistAdd")?.addEventListener("click", (ev) => {
    ev.preventDefault();
    const idEmpleado = $("editEmpId")?.value;
    const emp = db.empleados.find(e => e.idEmpleado === idEmpleado);
    if (!emp) return toast("Empleado no encontrado");

    const ini = $("histInicio")?.value.trim();
    const fin = $("histFin")?.value.trim();
    if (!ini || !fin) return toast("Complet√° inicio y fin");

    if (daysBetweenInclusive(ini, fin) <= 0) return toast("Fin no puede ser anterior al inicio");

    ensureEmpHist(emp);
    emp.historialPeriodos.push({ sociedad: currentSoc, inicio: toDDMMYYYY(ini), fin: toDDMMYYYY(fin) });
    $("histInicio").value = "";
    $("histFin").value = "";
    save();
    renderEmpHistUI(emp);
    renderDashboard();
    toast("Per√≠odo agregado al historial");
  });

  $("btnHistClose")?.addEventListener("click", (ev) => {
    ev.preventDefault();
    const idEmpleado = $("editEmpId")?.value;
    const emp = db.empleados.find(e => e.idEmpleado === idEmpleado);
    if (!emp) return toast("Empleado no encontrado");

    const finTxt = $("histCloseFin")?.value.trim();
    closePeriodoActualEmp(emp, finTxt);
    $("histCloseFin").value = "";
    save();
    renderEmpHistUI(emp);
    renderDashboard();
    toast("Per√≠odo actual cerrado");
  });

  $("empModalBack")?.addEventListener("click", (ev) => {
    if (ev.target?.id === "empModalBack") closeEmpEditor();
  });
  document.addEventListener("keydown", (ev) => {
    if (ev.key === "Escape") closeEmpEditor();
  });

  // ---------- Novedades: UI + Workflow ----------
  $("btnToggleNovImport")?.addEventListener("click", () => {
    const w = $("novImportWrap");
    if (!w) return;
    w.style.display = (w.style.display === "none" || !w.style.display) ? "block" : "none";
  });

  $("novEmpSelect")?.addEventListener("change", () => {
    // refresca combo de cargos y tabla
    renderNovedades();
  });

  $("novPeriodo")?.addEventListener("change", () => {
    // set default estado record
    getPeriodoObj(currentSoc, $("novPeriodo")?.value || "");
    save();
    renderNovedades();
  });

  $("btnAddNov")?.addEventListener("click", () => {
    const periodo = $("novPeriodo")?.value || "";
    const idEmpleado = $("novEmpSelect")?.value || "";
    const idCargo = $("novCargoSelect")?.value || "";
    const tipo = $("novTipoManual")?.value || "";
    const valor = toNum($("novVal")?.value);
    const fecha = $("novFecha")?.value || "";
    const detalle = ($("novDetalle")?.value || "").trim();

    if (!periodo) return toast("Seleccion√° per√≠odo");
    if (isPeriodoCerrado(currentSoc, periodo)) return toast("Per√≠odo cerrado");
    if (!idEmpleado) return toast("Seleccion√° empleado");
    if (!tipo) return toast("Seleccion√° tipo");
    if (tipo !== "Licencia" && tipo !== "Baja Cargo" && valor <= 0) return toast("Valor inv√°lido (debe ser > 0)");

    // Validate employee belongs to society via cargo
    const emp = db.empleados.find(e => e.idEmpleado === idEmpleado);
    if (!emp || !(emp.cargos || []).some(c => c.sociedad === currentSoc)) return toast("Empleado no v√°lido para esta sociedad");

    db.novedades.push({
      idNovedad: uid(),
      sociedad: currentSoc,
      periodo,
      idEmpleado,
      idCargo: idCargo || "",
      tipo,
      valor: (tipo === "Licencia" || tipo === "Baja Cargo") ? (valor || 0) : valor,
      detalle,
      fecha,
      estado: "cargada",
      origen: { manual: true }
    });

    // Registrar en auditor√≠a
    logAudit('novedad', {
      idEmpleado,
      cuil: emp.cuil,
      nombreEmpleado: emp.apellidoNombre,
      campo: tipo,
      valorNuevo: `${valor} - ${detalle || '(sin detalle)'}`,
      detalle: `Per√≠odo: ${periodo}`,
      accion: 'creacion'
    });

    save();
    renderNovedades();
    toast("Novedad agregada");
  });

  $("btnAddPeriodoNota")?.addEventListener("click", () => {
    const periodo = $("novPeriodo")?.value || "";
    if (!periodo) return toast("Seleccion√° per√≠odo");
    const nota = ($("periodoNota")?.value || "").trim();
    if (!nota) return toast("Escrib√≠ una nota");
    addPeriodoNota(currentSoc, periodo, nota);
    $("periodoNota").value = "";
    renderPeriodoUI();
    toast("Nota guardada");
  });

  const doSetEstado = (estado, autoNote) => {
    const periodo = $("novPeriodo")?.value || "";
    if (!periodo) return toast("Seleccion√° per√≠odo");
    if (estado === "cerrado") {
      if (!confirm(`Cerrar per√≠odo ${periodo} para ${currentSoc}? Luego no podr√°s cargar novedades.`)) return;
      cerrarPeriodo(currentSoc, periodo);
      renderNovedades();
      return toast("Per√≠odo cerrado");
    }
    if (estado === "abierto") {
      reabrirPeriodo(currentSoc, periodo);
      renderNovedades();
      return toast("Per√≠odo reabierto");
    }

    // snapshot al enviar
    if (estado === "enviado") {
      const p = getPeriodoObj(currentSoc, periodo);
      const novs = db.novedades.filter(n => n.sociedad === currentSoc && n.periodo === periodo);
      p.snapshotEnviado = JSON.parse(JSON.stringify(novs));
      setPeriodoEstado(currentSoc, periodo, "enviado", autoNote || "Enviado a liquidador (snapshot)");
      renderNovedades();
      return toast("Enviado (snapshot guardado)");
    }

    setPeriodoEstado(currentSoc, periodo, estado, autoNote || `Estado: ${estado}`);
    renderNovedades();
    toast(`Estado: ${estado}`);
  };

  $("btnPeriodoEnviar")?.addEventListener("click", () => doSetEstado("enviado"));
  $("btnPeriodoLiquidado")?.addEventListener("click", () => doSetEstado("liquidado"));
  $("btnPeriodoRevisado")?.addEventListener("click", () => doSetEstado("revisado"));
  $("btnPeriodoAprobado")?.addEventListener("click", () => doSetEstado("aprobado"));
  $("btnPeriodoCerrar")?.addEventListener("click", () => doSetEstado("cerrado"));
  $("btnPeriodoAbrir")?.addEventListener("click", () => doSetEstado("abierto"));

  $("btnExportNovLiquidador")?.addEventListener("click", exportNovedadesLiquidador);
  $("btnExportNovRevision")?.addEventListener("click", exportNovedadesRevision);
  $("btnDiffEnviado")?.addEventListener("click", diffConEnviado);
  $("btnExportPlanillaLiquidadorXlsx")?.addEventListener("click", () => {
    const p = $("novPeriodo")?.value || periodoActivo();
    exportPlanillaLiquidadorXlsx(p);
  });

  // Importador novedades
  $("btnNovImpDetect")?.addEventListener("click", detectNovImportColumns);
  $("novImpFile")?.addEventListener("change", () => { $("btnNovImpImport").disabled = true; });
  $("novImpMapGrid")?.addEventListener("change", (ev) => {
    const sel = ev.target?.closest?.("select");
    if (!sel) return;
    const key = sel.dataset.map;
    if (!key) return;
    novImpMap[key] = sel.value || "";
    renderNovImportMappingUI();
  });
  $("btnNovImpImport")?.addEventListener("click", importNovedadesDesdeArchivo);
  $("btnNovDownloadRejected")?.addEventListener("click", () => {
    if (!novImpRejectedRows.length) return;
    exportCSV(novImpRejectedRows, `rechazadas_novedades_${currentSoc}_${$("novPeriodo")?.value || ""}.csv`);
  });


  // Control liquidaci√≥n (importable)
  $("btnLiqCtrlDetect")?.addEventListener("click", detectLiqCtrlColumns);
  $("liqCtrlFile")?.addEventListener("change", () => {
    $("btnLiqCtrlAnalyze") && ($("btnLiqCtrlAnalyze").disabled = true);
    $("btnLiqCtrlDownloadDiff") && ($("btnLiqCtrlDownloadDiff").disabled = true);
    liqCtrlRows = []; liqCtrlHeaders = []; liqCtrlDiffRows = [];
    renderLiqCtrlUI();
  });
  $("liqCtrlMapGrid")?.addEventListener("change", (ev) => {
    const sel = ev.target?.closest?.("select");
    if (!sel) return;
    const key = sel.dataset.map;
    if (!key) return;
    liqCtrlMap[key] = sel.value || "";
    // al mapear, resetear diferencias
    liqCtrlDiffRows = [];
    renderLiqCtrlUI();
  });
  $("btnLiqCtrlAnalyze")?.addEventListener("click", analyzeLiqCtrlDiff);
  $("btnLiqCtrlDownloadDiff")?.addEventListener("click", () => {
    if (!liqCtrlDiffRows.length) return toast("No hay diferencias para exportar");
    exportCSV(liqCtrlDiffRows, `diferencias_liquidacion_${currentSoc}_${$("novPeriodo")?.value || ""}.csv`);
  });


  // Import mapping change
  $("impMapGrid")?.addEventListener("change", (ev) => {
    const sel = ev.target?.closest?.("select");
    if (!sel) return;
    const key = sel.dataset.map;
    if (!key) return;
    impMap[key] = sel.value || "";
    renderImportMappingUI();
  });



  // ---------- Respaldo local (JSON) ----------
  const downloadDB = () => {
    try {
      const payload = JSON.stringify(db, null, 2);
      const blob = new Blob([payload], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `liquidacion_respaldo_${currentSoc}_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    } catch (e) {
      console.error(e);
      toast("No se pudo generar el respaldo");
    }
  };

  const importDBFromFile = async (file) => {
    try {
      const txt = await file.text();
      const data = JSON.parse(txt);
      if (!data || typeof data !== "object") throw new Error("JSON inv√°lido");
      if (!Array.isArray(data.empleados) || !Array.isArray(data.novedades)) throw new Error("Respaldo no compatible");

      // Normalizar + migraciones m√≠nimas
      db = data;
      db.empleados = db.empleados || [];
      db.novedades = db.novedades || [];
      db.periodosCerrados = db.periodosCerrados || [];
      db.periodos = db.periodos || [];
      db.config = db.config || {};
      db.config.nivelLiquidacionBySoc = db.config.nivelLiquidacionBySoc || { CFPEA: "MEDIA", ISFTEA: "SUPERIOR" };
      db.empleados.forEach(ensureEmpHist);

      save();
      renderDashboard();
      renderEmpleados();
      renderAntiguedades();
      renderNovedades();
      toast("Respaldo importado");
    } catch (e) {
      console.error(e);
      toast("No se pudo importar el respaldo (archivo inv√°lido)");
    }
  };

  // ---------- Exportaci√≥n formato liquidador (XLSX) ----------
  const exportPlanillaLiquidadorXlsx = (periodo) => {
    try {
      if (!periodo) return toast("Eleg√≠ un per√≠odo (YYYY-MM) primero");
      const yy = Number(periodo.slice(0,4));
      const mm = Number(periodo.slice(5,7));
      const AA = String(yy % 100); // 2 d√≠gitos si quer√©s: padStart(2,"0")
      const MM = String(mm);

      const headers = [
        "C.U.I.L.",
        "s.rev",
        "puntaje",
        "Apellido y Nombre",
        "Cargo",
        "Hs.Ca",
        "ALTA",
        "DTO. OBL",
        "LICENCIA",
        "OBSERVACIONES",
        "Dia Baja",
        "Mes Baja",
        "A√±o Baja",
        "AA",
        "MM"
      ];

      const rows = [];
      const emps = (db.empleados || []).filter(e => (e.cargos || []).some(c => c.sociedad === currentSoc));
      emps.forEach(emp => {
        const cargos = (emp.cargos || []).filter(c => c.sociedad === currentSoc);
        cargos.forEach(cargo => {
          const novs = (db.novedades || []).filter(n => n.periodo === periodo && n.idEmpleado === emp.idEmpleado && (n.idCargo || "") === (cargo.idCargo || ""));
          const dto = novs.filter(n => /dto|descuento/i.test(n.tipo || "")).reduce((acc, n) => acc + (Number(n.valor) || 0), 0);
          const lic = novs.filter(n => /licen/i.test(n.tipo || "")).map(n => String(n.observ || n.detalle || "").trim()).filter(Boolean);
          const obs = novs.filter(n => /obs|observ/i.test(n.tipo || "")).map(n => String(n.observ || n.detalle || "").trim()).filter(Boolean);
          const baja = novs.find(n => /baja/i.test(n.tipo || ""))?.fecha || cargo.fechaBajaCargo || "";

          let ddB="", mmB="", yyB="";
          const dB = parseDateFlexible(baja);
          if (dB) { ddB = String(dB.getDate()); mmB = String(dB.getMonth()+1); yyB = String(dB.getFullYear()); }

          rows.push({
            "C.U.I.L.": emp.cuil || "",
            "s.rev": emp.sitRevista || "",
            "puntaje": emp.puntaje || "",
            "Apellido y Nombre": emp.apellidoNombre || "",
            "Cargo": cargo.cargo || "",
            "Hs.Ca": cargo.horas ?? "",
            "ALTA": cargo.fechaAltaCargo || "",
            "DTO. OBL": dto ? dto : "",
            "LICENCIA": lic.join(" | "),
            "OBSERVACIONES": obs.join(" | "),
            "Dia Baja": ddB,
            "Mes Baja": mmB,
            "A√±o Baja": yyB,
            "AA": AA,
            "MM": MM
          });
        });
      });

      const ws = XLSX.utils.json_to_sheet(rows, { header: headers });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Novedades");
      const fname = `Novedades_${currentSoc}_${periodo}.xlsx`;
      XLSX.writeFile(wb, fname);
      toast("Planilla exportada");
    } catch (e) {
      console.error(e);
      toast("No se pudo exportar la planilla");
    }
  };



  $("btnDbExport")?.addEventListener("click", downloadDB);
  $("btnDbImport")?.addEventListener("click", () => {
    const f = $("dbImportFile")?.files?.[0];
    if (!f) return toast("Seleccion√° un JSON");
    importDBFromFile(f);
  });

  const syncNivelSelector = () => {
    const sel = $("nivelLiquidacion");
    if (!sel) return;
    sel.value = getNivelLiquidacion(currentSoc);
  };

  $("nivelLiquidacion")?.addEventListener("change", () => {
    setNivelLiquidacion(currentSoc, $("nivelLiquidacion").value);
    save();
    renderDashboard();
    toast("Nivel guardado para " + currentSoc);
  });


  // ---------- Sociedad (CFPEA / ISFTEA) ----------
  const setCurrentSoc = (soc) => {
    if (!["CFPEA","ISFTEA"].includes(soc)) return;
    currentSoc = soc;
    db.config = db.config || {};
    db.config.currentSoc = soc;
    save();

    // UI toggle (header)
    document.querySelectorAll(".societyToggle [data-soc]").forEach(b => {
      const is = (b.getAttribute("data-soc") === soc);
      b.classList.toggle("active", is);
    });

    // Sync nivel selector and rerenders
    syncNivelSelector();
    renderDashboard();
    renderEmpleados();
    renderAntiguedades();
    renderNovedades();

    // refresh import previews if open
    try { renderImportMappingUI(); } catch(e) {}
    try { renderNovImportMappingUI(); } catch(e) {}
    try { toggleComparador(false); } catch(e) {}
  };

  document.querySelectorAll(".societyToggle [data-soc]").forEach(btn => {
    btn.addEventListener("click", () => setCurrentSoc(btn.getAttribute("data-soc")));
  });


  // Set inicial
  setCurrentSoc(currentSoc);

  // Default period
  if ($("novPeriodo") && !$("novPeriodo").value) $("novPeriodo").value = new Date().toISOString().slice(0, 7);

  // ---------- Init ----------
  showTab("dashboard");
})();

</script>
</body>
</html>
